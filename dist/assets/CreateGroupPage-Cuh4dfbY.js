import{F as ae,v as oe,y as te,r as V,a2 as se,I as re,J as r,L as a,M as le,N as o,ak as ne,aq as z,X as P,a6 as T,ar as ie,al as ue,W as g,a8 as F,am as de,O as l,ap as ce,ae as f,Y as N,as as ge,ag as H,ac as x,U as me,at as pe,au as fe,av as J,ao as ve,Q as we,H as ye,$ as b,aw as be,ax as he,ay as Ie,R as G,a0 as _e}from"./index-CkJ7yJ3n.js";import{groupService as W}from"./group.service-CH2Rgjsj.js";const ke={class:"create-group-container"},Ce={class:"form-section"},Pe={class:"photo-upload-container"},Ge={key:0,class:"photo-preview"},De=["src"],Ee={class:"form-section"},Re={key:0,class:"error-message"},Ve={key:1,class:"error-message"},Fe={class:"form-section"},Ne={class:"form-section"},xe={class:"tags-placeholder"},Ue={class:"form-actions"},Te=ae({__name:"CreateGroupPage",setup(Be){const B=ye(),h=oe(),{storage:S}=te(),t=V({name:"",bio:"",isPrivate:!1,tags:[],logo:null,logoFile:null}),p=V({name:"",bio:""}),v=V(!1),D=V(null),q=se(()=>t.value.name.trim().length>0&&t.value.bio.trim().length>0);function Q(){B.back()}function X(){var i;(i=D.value)==null||i.click()}function K(i){var I;const d=(I=i.target.files)==null?void 0:I[0];if(d){t.value.logoFile=d;const _=new FileReader;_.onload=E=>{var k;t.value.logo=(k=E.target)==null?void 0:k.result},_.readAsDataURL(d)}}function Z(){t.value.logo=null,t.value.logoFile=null,D.value&&(D.value.value="")}function ee(){p.value={name:"",bio:""};let i=!0;return t.value.name.trim()?t.value.name.length>50&&(p.value.name="Name must be 50 characters or less",i=!1):(p.value.name="Name is required",i=!1),t.value.bio.trim()?t.value.bio.length>500&&(p.value.bio="Description must be 500 characters or less",i=!1):(p.value.bio="Description is required",i=!1),i}async function U(){var i,e,d,I,_,E,k,A,L,O,$,j,M;if(ee()){if(!((i=h.user)!=null&&i.id)){await(await b.create({message:"You must be logged in to create a group",duration:2e3,color:"danger"})).present();return}v.value=!0;try{if(!h.user)throw new Error("User not found");const s=h.user,m=s.inDemoCommunityId||s.communityId||s.community_id||null;if(!m){await(await b.create({message:"You must be part of a community to create a group. Please join a community first.",duration:4e3,color:"warning"})).present(),v.value=!1;return}let w;if(t.value.logoFile&&S)try{const c=h.user.id,y="group_".concat(c,"_").concat(Date.now()),R=be(S,"images/".concat(y));await he(R,t.value.logoFile),w=await Ie(R)}catch(c){console.error("Error uploading logo:",c),await(await b.create({message:c.message||"Failed to upload logo. Creating group without logo.",duration:3e3,color:"warning"})).present()}const u={name:t.value.name.trim(),bio:t.value.bio.trim(),leaderId:h.user.id,communityId:m,isPrivate:t.value.isPrivate,tags:t.value.tags&&t.value.tags.length>0?t.value.tags:[]};if(w&&w.trim().length>0)try{new URL(w),u.logo=w}catch(c){console.warn("Invalid logo URL, creating group without logo:",c)}console.log("Creating group with data:",JSON.stringify(u,null,2)),console.log("Data types:",{name:typeof u.name,bio:typeof u.bio,leaderId:typeof u.leaderId,communityId:typeof u.communityId,isPrivate:typeof u.isPrivate,tags:Array.isArray(u.tags),logo:u.logo?typeof u.logo:"undefined"});let n=null,C=0;const Y=2;for(;!n&&C<=Y;)try{n=await W.createGroup(u);break}catch(c){if(C++,C>Y)throw c;if(c.status===500&&w&&C===1){console.warn("First attempt failed with logo, retrying without logo...");const y={...u};delete y.logo;try{n=await W.createGroup(y),await(await b.create({message:"Group created successfully (logo upload will be processed separately)",duration:3e3,color:"warning"})).present();break}catch(R){console.warn("Retry without logo also failed, trying again with original data...")}}else await new Promise(y=>setTimeout(y,500*C))}if(!n)throw new Error("Group creation failed after retries");await(await b.create({message:"Group created successfully!",duration:2e3,color:"success"})).present(),await new Promise(c=>setTimeout(c,300)),B.push("/tabs/groups")}catch(s){console.error("Error creating group:",s),console.error("Error details:",{message:s.message,stack:s.stack,response:s.response||((e=s.originalError)==null?void 0:e.response),status:s.status||((I=(d=s.originalError)==null?void 0:d.response)==null?void 0:I.status),responseData:((_=s.response)==null?void 0:_.data)||((k=(E=s.originalError)==null?void 0:E.response)==null?void 0:k.data)});let m="Failed to create group. Please try again.";if(s.message&&s.message!=="{}"&&s.message!=="Request failed")m=s.message;else if((A=s.response)!=null&&A.data){const n=s.response.data;n.message&&n.message!=="{}"?m=n.message:n.error&&(m=n.error)}else if((O=(L=s.originalError)==null?void 0:L.response)!=null&&O.data){const n=s.originalError.response.data;n.message&&n.message!=="{}"?m=n.message:n.error&&(m=n.error)}(s.status||((j=($=s.originalError)==null?void 0:$.response)==null?void 0:j.status)||((M=s.response)==null?void 0:M.status))===500&&(m="Server error occurred. Please check that all required fields are filled and try again."),await(await b.create({message:m,duration:4e3,color:"danger"})).present()}finally{v.value=!1}}}return(i,e)=>(G(),re(a(le),null,{default:r(()=>[o(a(de),null,{default:r(()=>[o(a(ne),null,{default:r(()=>[o(a(z),{slot:"start"},{default:r(()=>[o(a(P),{onClick:Q},{default:r(()=>[o(a(T),{icon:a(ie)},null,8,["icon"])]),_:1})]),_:1}),o(a(ue),null,{default:r(()=>[...e[3]||(e[3]=[g("Create Group",-1)])]),_:1}),o(a(z),{slot:"end"},{default:r(()=>[o(a(P),{onClick:U,disabled:!q.value||v.value},{default:r(()=>[g(F(v.value?"Creating...":"Create"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),o(a(we),{fullscreen:!0,class:"create-group-content"},{default:r(()=>[l("div",ke,[l("form",{onSubmit:ce(U,["prevent"])},[l("div",Ce,[o(a(f),{class:"section-label"},{default:r(()=>[...e[4]||(e[4]=[g("Group Photo",-1)])]),_:1}),l("div",Pe,[t.value.logo?(G(),N("div",Ge,[l("img",{src:t.value.logo,alt:"Group logo"},null,8,De),o(a(P),{fill:"clear",size:"small",onClick:Z,class:"remove-photo"},{default:r(()=>[...e[5]||(e[5]=[g(" Remove ",-1)])]),_:1})])):(G(),N("div",{key:1,class:"photo-placeholder",onClick:X},[o(a(T),{icon:a(ge)},null,8,["icon"]),e[6]||(e[6]=l("p",null,"Tap to add photo",-1))])),l("input",{ref_key:"fileInput",ref:D,type:"file",accept:"image/*",onChange:K,style:{display:"none"}},null,544)])]),l("div",Ee,[o(a(f),{class:"section-label"},{default:r(()=>[...e[7]||(e[7]=[g("Group Information",-1)])]),_:1}),o(a(x),{class:"form-item",lines:"full"},{default:r(()=>[o(a(f),{position:"stacked"},{default:r(()=>[...e[8]||(e[8]=[g("Group Name",-1)])]),_:1}),o(a(me),{modelValue:t.value.name,"onUpdate:modelValue":e[0]||(e[0]=d=>t.value.name=d),placeholder:"New Group Name",maxlength:50,required:""},null,8,["modelValue"])]),_:1}),p.value.name?(G(),N("div",Re,F(p.value.name),1)):H("",!0),o(a(x),{class:"form-item",lines:"full"},{default:r(()=>[o(a(f),{position:"stacked"},{default:r(()=>[...e[9]||(e[9]=[g("Description",-1)])]),_:1}),o(a(pe),{modelValue:t.value.bio,"onUpdate:modelValue":e[1]||(e[1]=d=>t.value.bio=d),placeholder:"Group Description",maxlength:500,rows:4,required:""},null,8,["modelValue"])]),_:1}),p.value.bio?(G(),N("div",Ve,F(p.value.bio),1)):H("",!0)]),l("div",Fe,[o(a(f),{class:"section-label"},{default:r(()=>[...e[10]||(e[10]=[g("Privacy",-1)])]),_:1}),o(a(fe),{modelValue:t.value.isPrivate,"onUpdate:modelValue":e[2]||(e[2]=d=>t.value.isPrivate=d)},{default:r(()=>[o(a(x),{lines:"none"},{default:r(()=>[o(a(J),{slot:"start",value:!1}),o(a(f),null,{default:r(()=>[...e[11]||(e[11]=[l("h3",null,"Public",-1),l("p",null,"Anyone can find and join this group",-1)])]),_:1})]),_:1}),o(a(x),{lines:"none"},{default:r(()=>[o(a(J),{slot:"start",value:!0}),o(a(f),null,{default:r(()=>[...e[12]||(e[12]=[l("h3",null,"Private",-1),l("p",null,"Only invited members can join",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),l("div",Ne,[o(a(f),{class:"section-label"},{default:r(()=>[...e[13]||(e[13]=[g("Tags",-1)])]),_:1}),e[15]||(e[15]=l("p",{class:"section-description"},"Add tags to help people find your group",-1)),l("div",xe,[o(a(P),{fill:"outline",size:"small"},{default:r(()=>[o(a(T),{icon:a(ve),slot:"start"},null,8,["icon"]),e[14]||(e[14]=g(" Add Tags ",-1))]),_:1})])]),l("div",Ue,[o(a(P),{expand:"block",onClick:U,disabled:!q.value||v.value,class:"submit-button"},{default:r(()=>[g(F(v.value?"Creating...":"Create Group"),1)]),_:1},8,["disabled"])])],32)])]),_:1})]),_:1}))}}),Le=_e(Te,[["__scopeId","data-v-8809e275"]]);export{Le as default};
