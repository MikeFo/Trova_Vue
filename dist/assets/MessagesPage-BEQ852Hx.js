import{u as z,C as J}from"./ChatThread-CMJ0NHdj.js";import{F as Q,a1 as E,r as h,a2 as _,G,a3 as H,o as X,a4 as U,I as C,J as m,L as o,M as Y,N as c,Y as l,O as n,a5 as Z,Z as $,a6 as T,a7 as j,a8 as v,a9 as K,aa as B,ab as P,Q as ee,R as a,ac as se,ad as te,ae,X as ne,W as I,af as oe,ag as k,ah as le,ai as ie,a0 as re}from"./index-CkJ7yJ3n.js";import{profileService as ue}from"./profile.service-CDoO2DLV.js";const ce={key:0,class:"conversations-container"},de={class:"search-container"},me={key:0,class:"loading-container"},ve={key:1,class:"empty-state"},fe={class:"empty-icon"},ge={class:"member-list"},_e={class:"member-list-header"},he={key:0,class:"loading-inline"},pe={key:1,class:"member-count"},ye={key:0,class:"loading-container inline"},Ce={key:1,class:"empty-members"},ke=["src","alt"],we={class:"member-email"},Me={key:2,class:"conversations-list"},Ie=["onClick"],Le={class:"conversation-avatar"},be=["src","alt"],Ne={key:1,class:"avatar-placeholder"},Se={key:2,class:"multi-user-badge"},Ue={key:3,class:"online-indicator"},$e={class:"conversation-content"},Te={class:"conversation-header"},Be={class:"conversation-name"},Pe={key:0,class:"slack-badge"},xe={class:"conversation-time"},Ae={class:"conversation-preview"},Ve={class:"last-message"},Re={key:1,class:"active-chat-wrapper"},De="https://placehold.co/64x64?text=User",Fe=Q({__name:"MessagesPage",setup(qe){const r=z(),x=E(),L=H(),g=h(""),d=h(null);h(!1);const w=h([]),p=h(!1),A=_(()=>r.conversationsList),V=_(()=>r.isLoading);_(()=>r.unreadCount);const f=_(()=>x.currentCommunityId),b=_(()=>{const s=r.conversationsList;if(!g.value.trim())return s;const t=g.value.toLowerCase();return s.filter(e=>{const i=(e.messageTitle||"").toLowerCase(),u=(e.lastMessage||"").toLowerCase();return i.includes(t)||u.includes(t)})}),M=_(()=>{const s=[...w.value];if(s.sort((e,i)=>{const u=(e.fullName||"".concat(e.fname||""," ").concat(e.lname||"")||e.email||"").toLowerCase(),y=(i.fullName||"".concat(i.fname||""," ").concat(i.lname||"")||i.email||"").toLowerCase();return u.localeCompare(y)}),!g.value.trim())return s;const t=g.value.toLowerCase();return s.filter(e=>{const i=(e.fullName||"".concat(e.fname||""," ").concat(e.lname||"")||"").toLowerCase(),u=(e.email||"").toLowerCase();return i.includes(t)||u.includes(t)})});function R(s){d.value=s,r.setActiveConversation(s.conversationId)}async function D(s){if(!f.value){console.warn("No community selected");return}await r.startConversationWithUser(Number(s.id),f.value),d.value=r.activeConversation}function F(s){var t;return s.lastMessage?s.lastMessage.replace(/<[^>]*>/g,"").substring(0,50):s.messages&&s.messages.length>0&&((t=s.messages[s.messages.length-1].message)==null?void 0:t.replace(/<[^>]*>/g,"").substring(0,50))||"No messages"}function q(s){if(!s)return"";const t=s.toDate(),i=new Date().getTime()-t.getTime(),u=Math.floor(i/6e4),y=Math.floor(i/36e5),S=Math.floor(i/864e5);return u<1?"Just now":u<60?"".concat(u,"m"):y<24?"".concat(y,"h"):S<7?"".concat(S,"d"):t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function O(s){return s.isRead?0:1}function W(s){return!s.isMultiUser||!s.users?0:Math.max(0,s.users.length-1)}G(async()=>{await r.loadConversations(),r.subscribeToConversations(),await N();const s=L.query.userId?Number(L.query.userId):null;if(s&&f.value)try{await r.startConversationWithUser(s,f.value),d.value=r.activeConversation}catch(t){console.error("Failed to start conversation from route param",t)}}),X(()=>{r.cleanup()}),U(()=>r.activeConversation,s=>{d.value=s}),U(()=>f.value,async(s,t)=>{s&&s!==t&&await N()});async function N(){if(f.value){p.value=!0;try{w.value=await ue.getProfilesForUserAndCommunity(f.value)}catch(s){console.error("Failed to load members",s),w.value=[]}finally{p.value=!1}}}return(s,t)=>(a(),C(o(Y),null,{default:m(()=>[c(o(ee),{fullscreen:!0,class:"messages-content"},{default:m(()=>[d.value?(a(),l("div",Re,[c(J,{conversation:d.value,onBack:t[1]||(t[1]=e=>d.value=null)},null,8,["conversation"])])):(a(),l("div",ce,[n("div",de,[c(o(Z),{modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=e=>g.value=e),placeholder:"Search conversations...",class:"conversations-search",debounce:300},null,8,["modelValue"])]),V.value&&A.value.length===0?(a(),l("div",me,[c(o($)),t[2]||(t[2]=n("p",null,"Loading conversations...",-1))])):o(b).length===0?(a(),l("div",ve,[n("div",fe,[c(o(T),{icon:o(j)},null,8,["icon"])]),t[6]||(t[6]=n("h3",{class:"empty-title"},"Start a new conversation",-1)),t[7]||(t[7]=n("p",{class:"empty-description"}," Choose anyone in your community to begin messaging. ",-1)),n("div",ge,[n("div",_e,[t[3]||(t[3]=n("span",null,"All members (alphabetical)",-1)),p.value?(a(),l("span",he,"Loading...")):(a(),l("span",pe,v(M.value.length)+" people",1))]),p.value?(a(),l("div",ye,[c(o($))])):M.value.length===0?(a(),l("div",Ce,[...t[4]||(t[4]=[n("p",null,"No matching people.",-1)])])):(a(),C(o(K),{key:2,class:"members-list"},{default:m(()=>[(a(!0),l(B,null,P(M.value,e=>(a(),C(o(se),{key:e.id,button:"",onClick:i=>D(e)},{default:m(()=>[c(o(te),{slot:"start"},{default:m(()=>[n("img",{src:e.profilePicture||e.profilePictureThumbnail||De,alt:e.fullName||e.email},null,8,ke)]),_:2},1024),c(o(ae),null,{default:m(()=>[n("h3",null,v(e.fullName||e.fname+" "+e.lname||e.email),1),n("p",we,v(e.email),1)]),_:2},1024),c(o(ne),{slot:"end",size:"small",fill:"outline"},{default:m(()=>[...t[5]||(t[5]=[I("Message",-1)])]),_:1})]),_:2},1032,["onClick"]))),128))]),_:1}))])])):(a(),l("div",Me,[(a(!0),l(B,null,P(o(b),e=>{var i;return a(),l("div",{key:e.conversationId,class:oe(["conversation-item",{unread:!e.isRead,active:((i=d.value)==null?void 0:i.conversationId)===e.conversationId}]),onClick:u=>R(e)},[n("div",Le,[!e.isMultiUser&&e.messagesPicture?(a(),l("img",{key:0,src:e.messagesPicture,alt:e.messageTitle,class:"avatar-image"},null,8,be)):(a(),l("div",Ne,[c(o(T),{icon:o(le)},null,8,["icon"])])),e.isMultiUser?(a(),l("div",Se," +"+v(W(e)),1)):k("",!0),e.isOnline&&!e.isMultiUser?(a(),l("div",Ue)):k("",!0)]),n("div",$e,[n("div",Te,[n("h3",Be,[I(v(e.messageTitle||"Unknown"),1),e.isSlackBacked?(a(),l("span",Pe,"Slack")):k("",!0)]),n("span",xe,v(q(e.updatedAt||e.timestamp)),1)]),n("div",Ae,[n("p",Ve,v(F(e)),1),e.isRead?k("",!0):(a(),C(o(ie),{key:0,color:"primary",class:"unread-badge"},{default:m(()=>[I(v(O(e)),1)]),_:2},1024))])])],10,Ie)}),128))]))]))]),_:1})]),_:1}))}}),Qe=re(Fe,[["__scopeId","data-v-3ebae4c1"]]);export{Qe as default};
