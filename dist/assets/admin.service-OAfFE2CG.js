const __vite__fileDeps=["assets/profile.service-CDoO2DLV.js","assets/index-CkJ7yJ3n.js","assets/index-BoVDCu-3.css","assets/event.service-D7cjacjh.js","assets/group.service-CH2Rgjsj.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
var X=Object.defineProperty;var ee=(G,s,n)=>s in G?X(G,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):G[s]=n;var W=(G,s,n)=>(ee(G,typeof s!="symbol"?s+"":s,n),n);import{_ as L,x as T,y as K,z as H,A as O,B as x,C as Q,T as Z,D as J,E as V,e as te}from"./index-CkJ7yJ3n.js";class ne{constructor(){W(this,"matchesCache",new Map);W(this,"conversationsCache",new Map);W(this,"profilesCache",new Map);W(this,"CACHE_TTL",5*60*1e3);W(this,"FIREBASE_CACHE_TTL",10*60*1e3);W(this,"pendingRequests",new Map)}getMatchesCacheKey(s,n,u,d){return"matches_".concat(s,"_").concat(n||"all","_").concat(u||"all","_").concat(d||"all")}getConversationsCacheKey(s){return"conversations_".concat(s)}isCacheValid(s,n=this.CACHE_TTL){return Date.now()-s<n}clearExpiredCache(){for(const[s,n]of this.matchesCache.entries())this.isCacheValid(n.timestamp)||this.matchesCache.delete(s);for(const[s,n]of this.conversationsCache.entries())this.isCacheValid(n.timestamp,this.FIREBASE_CACHE_TTL)||this.conversationsCache.delete(s);for(const[s,n]of this.profilesCache.entries())this.isCacheValid(n.timestamp)||this.profilesCache.delete(s)}async getCachedProfiles(s){const n=this.profilesCache.get(s);if(n&&this.isCacheValid(n.timestamp))return console.log("[AdminService] âœ… Using cached profiles for community ".concat(s)),n.data;const{profileService:u}=await L(()=>import("./profile.service-CDoO2DLV.js"),__vite__mapDeps([0,1,2])),d=await u.getProfilesForUserAndCommunity(s);return this.profilesCache.set(s,{data:d,timestamp:Date.now()}),d}async isManager(s,n,u){if(u&&u.leaderId===n)return!0;try{const d=await T.get("/communities/".concat(s,"/managers/").concat(n,"/check"));return(d==null?void 0:d.isManager)||!1}catch(d){return u&&u.leaderId===n?!0:(console.error("Failed to check manager status:",d),!1)}}isSuperAdmin(s){return(te.production?[4147,3113,4136,14453]:[3434,3296,3422,2920,2583,2935]).includes(s)}async getAllCommunitiesForSuperAdmin(s){try{return await T.get("/users/".concat(s,"/all-communities-manager-of"))||[]}catch(n){return console.error("Failed to fetch all communities for super admin:",n),[]}}async getCommunityMembers(s){var n;try{return await T.get("/communities/".concat(s,"/members"))||[]}catch(u){if((u==null?void 0:u.status)===404||((n=u==null?void 0:u.response)==null?void 0:n.status)===404)try{const d=await this.getCachedProfiles(s),o=d.map(f=>f.userId||f.id).filter(f=>typeof f=="number"&&f>0);let p=new Map;if(o.length>0)try{const{userService:f}=await L(()=>import("./index-CkJ7yJ3n.js").then(t=>t.bZ),__vite__mapDeps([1,2]));p=await f.getUsersByIds(o)}catch(f){console.warn("[AdminService] Failed to fetch user emails:",f)}return d.map(f=>{const t=f.userId||f.id,m=p.get(t);return{id:t,fname:f.fname,lname:f.lname,fullName:f.fullName||"".concat(f.fname," ").concat(f.lname),email:(m==null?void 0:m.email)||"",profilePicture:f.profilePicture,isManager:!1,enabled:!0,joinDate:void 0}})}catch(d){return console.log("[AdminService] Members endpoint not found for community ".concat(s,", using empty array")),[]}return console.error("Failed to fetch community members:",u),[]}}async searchMembers(s,n){try{return await T.get("/communities/".concat(s,"/members/search?q=").concat(encodeURIComponent(n)))||[]}catch(u){return console.error("Failed to search members:",u),[]}}async toggleUserStatus(s,n){try{await T.put("/users/".concat(s,"/status"),{enabled:n})}catch(u){throw console.error("Failed to toggle user status:",u),u}}async toggleManager(s,n,u){try{u?await T.post("/communities/".concat(s,"/managers"),{userId:n}):await T.delete("/communities/".concat(s,"/managers/").concat(n))}catch(d){throw console.error("Failed to toggle manager:",d),d}}async updateCommunityBio(s,n){try{return await T.patch("/communities/".concat(s),{bio:n})}catch(u){throw console.error("Failed to update community bio:",u),u}}async updateCommunityLogo(s,n){try{return await T.patch("/communities/".concat(s),{logo:n})}catch(u){throw console.error("Failed to update community logo:",u),u}}async sendMessage(s,n,u){try{await T.post("/communities/".concat(s,"/messages"),{userIds:n,message:u})}catch(d){throw console.error("Failed to send message:",d),d}}async uploadDriverData(s,n){try{const u=new FormData;u.append("file",n),await T.post("/communities/".concat(s,"/data/drivers"),u)}catch(u){throw console.error("Failed to upload driver data:",u),u}}async uploadReportsToData(s,n){try{const u=new FormData;u.append("file",n),await T.post("/communities/".concat(s,"/data/reports-to"),u)}catch(u){throw console.error("Failed to upload reports-to data:",u),u}}async uploadMappedPairings(s,n){try{const u=new FormData;u.append("file",n),await T.post("/communities/".concat(s,"/data/pairings"),u)}catch(u){throw console.error("Failed to upload mapped pairings:",u),u}}async getAttributeChartData(s,n,u=!0,d=!0){try{const o="/communities/".concat(s,"/attribute?type=").concat(n,"&consolidateResults=").concat(u,"&onlyActive=").concat(d);return await T.get(o)||[]}catch(o){return console.error("Failed to fetch attribute data for ".concat(n,":"),o),[]}}async getSkillsChartData(s,n,u=!0,d=!0){try{const o="/communities/".concat(s,"/skills?type=").concat(n,"&consolidateResults=").concat(u,"&onlyActive=").concat(d);return await T.get(o)||[]}catch(o){return console.error("Failed to fetch skills data for ".concat(n,":"),o),[]}}async getBusinessTopicsChartData(s,n=!0,u=!0){try{const d="/communities/".concat(s,"/businessTopics?consolidateResults=").concat(n,"&onlyActive=").concat(u);return await T.get(d)||[]}catch(d){return console.error("Failed to fetch business topics data:",d),[]}}async getCustomFieldsForCharts(s){try{const n="/communities/".concat(s,"/custom-fields-for-charts");return await T.get(n)||[]}catch(n){return console.error("Failed to fetch custom fields for charts:",n),[]}}async getCustomFieldChartData(s,n,u=!0,d=!0){try{const o="/communities/".concat(s,"/custom-field-chart/").concat(n,"?consolidateResults=").concat(u,"&onlyActive=").concat(d),p=await T.get(o);return Array.isArray(p)||p&&Array.isArray(p.results)?p:p&&Array.isArray(p.data)?{results:p.data,fieldName:p.fieldName,customFieldName:p.customFieldName,fieldId:p.fieldId}:(console.warn("[AdminService] Unexpected response format for custom field ".concat(n,":"),p),[])}catch(o){return console.error("Failed to fetch custom field ".concat(n," data:"),o),[]}}async getUsersByAttribute(s,n,u,d=!0,o){var p,f,t,m;try{let e="/communities/".concat(s,"/attribute/users?type=").concat(n,"&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d);n==="skill"&&o&&(e+="&skillType=".concat(o)),n==="business_topic"&&(e+="&full=true"),e+="&limit=200";const h=await T.get(e);let a,i=null;if(Array.isArray(h)?a=h:h&&Array.isArray(h.data)?(a=h.data,i=h.pagination):(console.warn("[AdminService] Unexpected response format for ".concat(n,":").concat(u)),a=[]),!a||a.length===0)return[];if(i&&i.totalPages>1){const r=[...a],l=i.totalPages||1,v=i.currentPage||1;for(let g=v+1;g<=l;g++)try{let S="/communities/".concat(s,"/attribute/users?type=").concat(n,"&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d,"&limit=200&page=").concat(g);n==="skill"&&o&&(S+="&skillType=".concat(o)),n==="business_topic"&&(S+="&full=true");const A=await T.get(S),$=Array.isArray(A)?A:(A==null?void 0:A.data)||[];r.push(...$)}catch(S){console.warn("[AdminService] Failed to load page ".concat(g," for ").concat(n,":").concat(u,":"),S)}a=r}return a.map(r=>({id:r.id||r.userId,userId:r.userId||r.id,fname:r.fname||"",lname:r.lname||"",fullName:r.fullName||"".concat(r.fname||""," ").concat(r.lname||"").trim(),email:r.email||"",profilePicture:r.profilePicture,bio:r.bio,pronouns:r.pronouns,isManager:r.isManager,enabled:r.enabled,joinDate:r.joinDate,...r}))}catch(e){const h=(e==null?void 0:e.status)||((p=e==null?void 0:e.response)==null?void 0:p.status),a=(e==null?void 0:e.statusText)||((f=e==null?void 0:e.response)==null?void 0:f.statusText);return console.error("[AdminService] âŒ Error fetching users for ".concat(n,":").concat(u,":"),{status:h,statusText:a,message:e==null?void 0:e.message,response:(t=e==null?void 0:e.response)==null?void 0:t.data,fullError:e}),h===404?this.getUsersByAttributeFallback(s,n,u,d):h===400?(console.warn("[AdminService] 400 Bad Request for ".concat(n,":").concat(u,", attempting fallback")),this.getUsersByAttributeFallback(s,n,u,d)):h===500?(console.error("[AdminService] 500 Internal Server Error - Backend SQL query failed for ".concat(n,":").concat(u),(m=e==null?void 0:e.response)==null?void 0:m.data),this.getUsersByAttributeFallback(s,n,u,d)):(console.warn("[AdminService] Error ".concat(h," for ").concat(n,":").concat(u,", attempting fallback")),this.getUsersByAttributeFallback(s,n,u,d))}}async getUsersByAttributeFallback(s,n,u,d=!0){var o;try{const p=await this.getCachedProfiles(s),f=(u||"").trim().toLowerCase(),t=c=>(c||"").trim().toLowerCase()===f,m=c=>(c||"").trim().toLowerCase().includes(f),e=c=>c?(Array.isArray(c)?c:[c]).map(l=>l?typeof l=="string"?l:typeof l=="number"?String(l):typeof(l==null?void 0:l.name)=="string"?l.name:typeof(l==null?void 0:l.label)=="string"?l.label:typeof(l==null?void 0:l.primaryName)=="string"?l.primaryName:typeof(l==null?void 0:l.secondaryName)=="string"?l.secondaryName:typeof(l==null?void 0:l.value)=="string"?l.value:"":"").map(l=>l.trim()).filter(Boolean):[],h=c=>{var v,g,S,A,$,U;const r=c||{},l=r.data||r.profileData||r.profile||{};switch(n){case"interest":const _=[...e(r.interests),...e(l.interests),...e(r.dataInterests),...e(l.dataInterests),...e(r.passions),...e(l.passions),...e((v=r.profile)==null?void 0:v.interests),...e((g=r.profileData)==null?void 0:g.interests),...e((S=r.userProfile)==null?void 0:S.interests)];if(r.userThings&&Array.isArray(r.userThings)){for(const y of r.userThings)if(Array.isArray(y)&&y.length>=2){const C=y[0];if(C==="interest"||C==="interests"){const b=y[1];Array.isArray(b)?_.push(...e(b)):typeof b=="string"&&_.push(b.trim())}}}if(l.userThings&&Array.isArray(l.userThings)){for(const y of l.userThings)if(Array.isArray(y)&&y.length>=2){const C=y[0];if(C==="interest"||C==="interests"){const b=y[1];Array.isArray(b)?_.push(...e(b)):typeof b=="string"&&_.push(b.trim())}}}return _;case"activity":const M=[...e(r.activities),...e(l.activities),...e(r.dataActivities),...e(l.dataActivities),...e(r.passions),...e(l.passions),...e((A=r.profile)==null?void 0:A.activities),...e(($=r.profileData)==null?void 0:$.activities),...e((U=r.userProfile)==null?void 0:U.activities)];if(r.userThings&&Array.isArray(r.userThings)){for(const y of r.userThings)if(Array.isArray(y)&&y.length>=2){const C=y[0];if(C==="activity"||C==="activities"){const b=y[1];Array.isArray(b)?M.push(...e(b)):typeof b=="string"&&M.push(b.trim())}}}if(l.userThings&&Array.isArray(l.userThings)){for(const y of l.userThings)if(Array.isArray(y)&&y.length>=2){const C=y[0];if(C==="activity"||C==="activities"){const b=y[1];Array.isArray(b)?M.push(...e(b)):typeof b=="string"&&M.push(b.trim())}}}return M;case"intention":return[...e(r.intentions),...e(l.intentions),...e(r.intention),...e(l.intention)];case"movie":return[...e(r.movies),...e(l.movies)];case"music":return[...e(r.music),...e(l.music)];case"occupation":return[...e(r.occupation),...e(l.occupation),...e(r.jobTitle),...e(l.jobTitle)];case"organization":{const y=[];return y.push(...e(r.organizations)),y.push(...e(l.organizations)),y.push(...e(r.currentEmployer)),y.push(...e(l.currentEmployer)),y.push(...e(r.pastEmployers)),y.push(...e(l.pastEmployers)),y}case"university":{const y=[];return y.push(...e(r.university)),y.push(...e(l.university)),y.push(...e(r.school)),y.push(...e(l.school)),y.push(...e(r.education)),y.push(...e(l.education)),y}case"location":{const y=[];return y.push(...e(r.currentLocationName)),y.push(...e(l.currentLocationName)),y.push(...e(r.locations)),y.push(...e(l.locations)),y}case"businessTopic":case"business_topic":case"businessTopics":{const y=[...e(r.businessTopics),...e(l.businessTopics),...e(r.business_topics),...e(l.business_topics),...e(r.topics),...e(l.topics),...e(r.businessTopicsList),...e(l.businessTopicsList),...e(r.businessTopic),...e(l.businessTopic)];if(r.userThings&&Array.isArray(r.userThings)){for(const C of r.userThings)if(Array.isArray(C)&&C.length>=2){const b=C[0];if(b==="businessTopic"||b==="business_topic"||b==="businessTopics"||b==="topic"){const w=C[1];Array.isArray(w)?y.push(...e(w)):typeof w=="string"&&y.push(w.trim())}}}if(l.userThings&&Array.isArray(l.userThings)){for(const C of l.userThings)if(Array.isArray(C)&&C.length>=2){const b=C[0];if(b==="businessTopic"||b==="business_topic"||b==="businessTopics"||b==="topic"){const w=C[1];Array.isArray(w)?y.push(...e(w)):typeof w=="string"&&y.push(w.trim())}}}return y}default:return[]}},a=c=>(c==null?"":String(c)).trim().toLowerCase(),i=p.filter(c=>{if(d){const v=c==null?void 0:c.enabled,g=c==null?void 0:c.disabled;if(v===!1||g===!0)return!1}const r=h(c);if(!r||r.length===0)return!1;const l=n==="location";return r.some(v=>l?m(v):t(v))});if(i.length===0)try{const c=await this.getAttributeChartData(s,n,!1,d),r=y=>(y==null?"":String(y)).trim().toLowerCase(),l=r(u),v=n==="location",g=y=>(y==null?void 0:y.attribute)||(y==null?void 0:y.attributeName)||(y==null?void 0:y.attribute_name)||(y==null?void 0:y.label)||(y==null?void 0:y.valueName)||(y==null?void 0:y.value_name)||(y==null?void 0:y.skill)||(y==null?void 0:y.topic)||(y==null?void 0:y.name)||"",S=y=>{var b,w,I;const C=[y==null?void 0:y.userId,y==null?void 0:y.user_id,y==null?void 0:y.memberId,y==null?void 0:y.member_id,y==null?void 0:y.profileId,y==null?void 0:y.profile_id,y==null?void 0:y.slackUserId,y==null?void 0:y.slack_user_id,y==null?void 0:y.id,(b=y==null?void 0:y.user)==null?void 0:b.id,(w=y==null?void 0:y.user)==null?void 0:w.userId,(I=y==null?void 0:y.user)==null?void 0:I.user_id];for(const k of C){const P=typeof k=="string"?parseInt(k,10):k;if(typeof P=="number"&&Number.isFinite(P)&&P>0)return P}return null},A=new Set;let $=0,U=0,_=0,M=0;for(const y of c){const C=r(g(y));if(!C){_++;continue}if(!(v?C.includes(l):C===l)){M++;continue}$++;const w=S(y);w?(A.add(w),U++):console.log('[AdminService] âš ï¸ Matched row for "'.concat(u,'" but no user ID found:'),{label:g(y),normalizedLabel:C,keys:Object.keys(y),fullRow:y,stringified:JSON.stringify(y)})}if(A.size>0){const y=new Map;for(const b of p){const w=typeof(b==null?void 0:b.userId)=="string"?parseInt(b.userId,10):(o=b==null?void 0:b.userId)!=null?o:b==null?void 0:b.id;typeof w=="number"&&Number.isFinite(w)&&y.set(w,b)}const C=Array.from(A).map(b=>y.get(b)).filter(Boolean);if(console.log("[AdminService] Recovered ".concat(C.length," profiles from ").concat(A.size," user IDs")),C.length>0){const b=C.filter(w=>h(w).some(k=>v?m(k):t(k)));return b.length>0?b.map(w=>{var I;return{id:w.userId||w.id,fname:w.fname,lname:w.lname,fullName:w.fullName||"".concat(w.fname||""," ").concat(w.lname||"").trim(),email:w.email||"",profilePicture:w.profilePicture,isManager:!1,enabled:(I=w.enabled)!=null?I:!0,joinDate:void 0}}):(console.warn("[AdminService] âš ï¸ Verification filtered all users, returning unverified list"),C.map(w=>{var I;return{id:w.userId||w.id,fname:w.fname,lname:w.lname,fullName:w.fullName||"".concat(w.fname||""," ").concat(w.lname||"").trim(),email:w.email||"",profilePicture:w.profilePicture,isManager:!1,enabled:(I=w.enabled)!=null?I:!0,joinDate:void 0}}))}}else console.warn("[AdminService] âš ï¸ No user IDs found in unconsolidated data for ".concat(n,":").concat(u," (matched ").concat($," rows but none had user IDs)"))}catch(c){console.warn("[AdminService] Attribute fallback recovery via unconsolidated endpoint failed for ".concat(n,":").concat(u),c)}return i.map(c=>({id:c.userId||c.id,fname:c.fname,lname:c.lname,fullName:c.fullName||"".concat(c.fname||""," ").concat(c.lname||"").trim(),email:c.email||"",profilePicture:c.profilePicture,isManager:!1,enabled:!0,joinDate:void 0}))}catch(p){return console.error("Error in fallback user filtering:",p),[]}}getAttributeFieldName(s){return{interest:"interests",activity:"activities",intention:"intention",movie:"movies",music:"music",occupation:"occupation",organization:"organizations",university:"university",location:"locations"}[s]||null}async getUsersBySkill(s,n,u,d=!0){var p,f;const o=["/communities/".concat(s,"/skills/users?type=").concat(n,"&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d),"/communities/".concat(s,"/skills/").concat(encodeURIComponent(u),"/users?onlyActive=").concat(d),"/communities/".concat(s,"/users/skills?skill=").concat(encodeURIComponent(u),"&onlyActive=").concat(d),"/communities/".concat(s,"/attribute/users?type=skill&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d),"/communities/".concat(s,"/attribute/users?type=general&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d)];for(const t of o)try{const m=await T.get(t);if(m&&Array.isArray(m)&&m.length>0)return m}catch(m){if(((m==null?void 0:m.status)||((p=m==null?void 0:m.response)==null?void 0:p.status))===404)continue;console.warn("[AdminService] Error fetching users for skill ".concat(n,":").concat(u," from ").concat(t,":"),m)}console.log("[AdminService] âš ï¸ All skill endpoints failed, trying attribute endpoint for skill ".concat(n,":").concat(u));try{const t=await this.getUsersByAttribute(s,"skill",u,d,n||"general");if(t&&t.length>0)return console.log("[AdminService] âœ… Attribute endpoint found ".concat(t.length,' users with skill "').concat(u,'" (type: ').concat(n||"general",")")),t}catch(t){const m=(t==null?void 0:t.status)||((f=t==null?void 0:t.response)==null?void 0:f.status);console.log(m===400?"[AdminService] Attribute endpoint returned 400 - skill type might not be fully supported yet":"[AdminService] Attribute endpoint also failed (".concat(m,"), trying profile fallback"))}return this.getUsersBySkillFallback(s,n,u,d)}async getAllIndividualSkills(s,n=!0){const u=await this.getCachedProfiles(s),d=new Map;u.forEach(p=>{const f=p.dataSkills||p.skills||p.userSkills;let t=[];Array.isArray(f)?t=f.map(m=>typeof m=="string"?m:(m==null?void 0:m.name)||(m==null?void 0:m.skill)||(m==null?void 0:m.value)||"").filter(Boolean):typeof f=="string"&&(t=f.split(",").map(m=>m.trim()).filter(Boolean)),t.forEach(m=>{m&&d.set(m,(d.get(m)||0)+1)})});const o=Array.from(d.entries()).map(([p,f])=>({name:p,value:f})).sort((p,f)=>f.value-p.value);return console.log("[AdminService] âœ… Extracted ".concat(o.length," individual skills from profiles")),o}async getAllUsersWithSkills(s,n=!0){const d=(await this.getCachedProfiles(s)).map(o=>{const p=o.dataSkills||o.skills||o.userSkills;let f=[];return Array.isArray(p)?f=p.map(t=>typeof t=="string"?t:(t==null?void 0:t.name)||(t==null?void 0:t.skill)||(t==null?void 0:t.value)||""):typeof p=="string"&&(f=p.split(",").map(t=>t.trim()).filter(Boolean)),{id:o.userId||o.id,fname:o.fname,lname:o.lname,fullName:o.fullName||"".concat(o.fname," ").concat(o.lname),email:"",profilePicture:o.profilePicture,isManager:!1,enabled:!0,joinDate:void 0,jobTitle:o.jobTitle,currentEmployer:o.currentEmployer,skills:f,skillsDisplay:f.length>0?f.join(", "):"No skills listed"}}).filter(o=>!(n&&o.enabled===!1));return console.log("[AdminService] âœ… Found ".concat(d.length,' users with skills for "Other" category')),d}async getUsersBySkillFallback(s,n,u,d=!0){try{try{const m=await this.getSkillsChartData(s,n||"all",!1,d);console.log("[AdminService] Fallback: Got ".concat(m.length," unconsolidated skill entries"));const e=m.filter(h=>{const a=h.name||h.skill||h.value;return typeof a=="string"?a.toLowerCase().includes(u.toLowerCase()):(a==null?void 0:a.toLowerCase())===u.toLowerCase()});if(console.log("[AdminService] Found ".concat(e.length,' entries matching skill "').concat(u,'"')),e.length>0){const h=[];e.forEach(i=>{const c=[i.userId,i.user_id,i.memberId,i.member_id,i.profileId,i.profile_id,i.slackUserId,i.slack_user_id,i.id];for(const r of c){const l=typeof r=="string"?parseInt(r,10):r;if(typeof l=="number"&&Number.isFinite(l)&&l>0){h.push(l);break}}i.name&&typeof i.name=="string"&&i.name.split("|").forEach(l=>{const v=l.match(/userId[:\s]*(\d+)/i)||l.match(/user[:\s]*(\d+)/i);if(v&&v[1]){const S=parseInt(v[1],10);isNaN(S)||h.push(S)}const g=parseInt(l.trim(),10);!isNaN(g)&&g>0&&g<1e6&&h.push(g)})});const a=[...new Set(h)];if(console.log("[AdminService] Extracted ".concat(a.length," unique user IDs from unconsolidated data:"),a),a.length>0)try{const c=(await this.getCommunityMembers(s)).filter(r=>a.includes(r.id));if(d){const r=c.filter(l=>l.enabled!==!1);return console.log("[AdminService] âœ… Found ".concat(r.length,' active members with skill "').concat(u,'"')),r}return console.log("[AdminService] âœ… Found ".concat(c.length,' members with skill "').concat(u,'"')),c}catch(i){console.warn("[AdminService] Failed to fetch community members:",i)}}}catch(m){console.log("[AdminService] Unconsolidated skills approach failed:",m)}try{const m=await this.getCommunityMembers(s);console.log("[AdminService] Fallback: Checking ".concat(m.length,' community members for skill "').concat(u,'"'));const e=m.filter(h=>{var i;const a=h.skills||h.skill||h.userSkills||h.dataSkills||((i=h.attributes)==null?void 0:i.skills);return a?Array.isArray(a)?a.some(c=>{const r=typeof c=="string"?c:(c==null?void 0:c.name)||(c==null?void 0:c.skill)||(c==null?void 0:c.value);return(r==null?void 0:r.toLowerCase())===u.toLowerCase()}):typeof a=="string"?a.toLowerCase().includes(u.toLowerCase()):!1:!1});if(e.length>0)return console.log("[AdminService] âœ… Found ".concat(e.length,' members with skill "').concat(u,'" from community members')),d?e.filter(h=>h.enabled!==!1):e}catch(m){console.log("[AdminService] Community members approach failed:",m)}const o=await this.getCachedProfiles(s),p=m=>(m==null?"":String(m)).trim().toLowerCase(),f=p(u);console.log("[AdminService] Fallback: Filtering ".concat(o.length,' profiles for skill "').concat(u,'" (type: ').concat(n,")"));const t=o.map(m=>({id:m.userId||m.id,fname:m.fname,lname:m.lname,fullName:m.fullName||"".concat(m.fname," ").concat(m.lname),email:"",profilePicture:m.profilePicture,isManager:!1,enabled:!0,joinDate:void 0,jobTitle:m.jobTitle,currentEmployer:m.currentEmployer,_profile:m})).filter(m=>{const e=m._profile;let h=e.skills||e.dataSkills||e.userSkills;if(!h){for(const a of Object.keys(e))if(a.toLowerCase().includes("skill")){const i=e[a];if(i){h=i;break}}}return h?Array.isArray(h)?h.some(a=>{const i=typeof a=="string"?a:(a==null?void 0:a.name)||(a==null?void 0:a.skill)||(a==null?void 0:a.value)||(a==null?void 0:a.skillName),c=p(i);if(n&&n!=="general"){const r=typeof a=="object"?(a==null?void 0:a.type)===n||(a==null?void 0:a.skillType)===n||(a==null?void 0:a.can_be_mentor)||(a==null?void 0:a.wants_to_be_mentee):!0;return c===f&&(r||n==="general")}return c===f}):typeof h=="object"&&!Array.isArray(h)?Object.keys(h).some(a=>{const i=h[a],c=typeof i=="string"?i:(i==null?void 0:i.name)||(i==null?void 0:i.skill)||(i==null?void 0:i.value)||(i==null?void 0:i.skillName)||a;return(c==null?void 0:c.toLowerCase())===u.toLowerCase()}):typeof h=="string"?h.split(",").map(i=>i.trim()).some(i=>i.toLowerCase()===u.toLowerCase()):!1:!1});return t.forEach(m=>{delete m._profile}),console.log("[AdminService] âœ… Fallback: Found ".concat(t.length,' users with skill "').concat(u,'"')),t}catch(o){return console.error("[AdminService] Error in fallback skill filtering:",o),[]}}async getUsersByBusinessTopic(s,n,u=!0){var o,p,f;try{const t=await this.getUsersByAttribute(s,"business_topic",n,u);if(t&&t.length>0)return console.log("[AdminService] âœ… Attribute endpoint found ".concat(t.length,' users for business topic "').concat(n,'"')),t;console.log('[AdminService] âš ï¸ Attribute endpoint returned 0 users for business topic "'.concat(n,'"'))}catch(t){const m=(t==null?void 0:t.status)||((o=t==null?void 0:t.response)==null?void 0:o.status);m===500?(console.error('[AdminService] âŒ Attribute endpoint still returning 500 for business_topic "'.concat(n,'"')),console.error("[AdminService] Backend fix may not be deployed yet, or there may be another issue.")):console.error('[AdminService] âŒ Attribute endpoint failed for business_topic "'.concat(n,'":'),{status:m,message:t==null?void 0:t.message,response:(p=t==null?void 0:t.response)==null?void 0:p.data})}const d=["/communities/".concat(s,"/businessTopics/users?value=").concat(encodeURIComponent(n),"&onlyActive=").concat(u),"/communities/".concat(s,"/businessTopics/").concat(encodeURIComponent(n),"/users?onlyActive=").concat(u),"/communities/".concat(s,"/users/businessTopics?topic=").concat(encodeURIComponent(n),"&onlyActive=").concat(u)];for(const t of d)try{const m=await T.get(t);if(m&&Array.isArray(m)&&m.length>0)return console.log("[AdminService] âœ… Found ".concat(m.length,' users with business topic "').concat(n,'" from alternative endpoint')),m}catch(m){if(((m==null?void 0:m.status)||((f=m==null?void 0:m.response)==null?void 0:f.status))===404)continue;console.warn("[AdminService] Error fetching users for business topic ".concat(n," from ").concat(t,":"),m)}return this.getUsersByBusinessTopicFallback(s,n,u)}async getUsersByBusinessTopicFallback(s,n,u=!0){var d,o;try{const p=await this.getCachedProfiles(s),f=e=>(e==null?"":String(e)).trim().toLowerCase(),t=f(n);console.log("[AdminService] ðŸ” Business topic fallback: Checking ".concat(p.length,' profiles for "').concat(n,'"'));const m=p.map(e=>{var h;return{id:e.userId||e.id,fname:e.fname,lname:e.lname,fullName:e.fullName||"".concat(e.fname||""," ").concat(e.lname||"").trim(),email:e.email||"",profilePicture:e.profilePicture,isManager:!1,enabled:(h=e.enabled)!=null?h:!0,joinDate:void 0,_profile:e}}).filter(e=>{if(u&&e.enabled===!1)return!1;const a=e._profile||{},i=a.data||a.profileData||a.profile||{},c=a.businessTopics||i.businessTopics||a.business_topics||i.business_topics||a.topics||i.topics||a.businessTopicsList||i.businessTopicsList||a.businessTopic||i.businessTopic||a.business_topic||i.business_topic,r=a.userThings||i.userThings;if(r&&Array.isArray(r)){for(const l of r)if(Array.isArray(l)&&l.length>=2){const v=l[0];if(v==="businessTopic"||v==="business_topic"||v==="businessTopics"||v==="topic"){const g=l[1];if(Array.isArray(g)){if(g.some(A=>{const $=typeof A=="string"?A:(A==null?void 0:A.name)||(A==null?void 0:A.topic)||(A==null?void 0:A.value)||(A==null?void 0:A.label)||"";return f($)===t}))return!0}else if(typeof g=="string"&&f(g)===t)return!0}}}return c?Array.isArray(c)?c.some(l=>{const v=typeof l=="string"?l:(l==null?void 0:l.name)||(l==null?void 0:l.topic)||(l==null?void 0:l.value)||(l==null?void 0:l.label);return f(v)===t}):typeof c=="string"?c.split(",").map(v=>f(v)).includes(t):!1:!1});if(m.forEach(e=>{delete e._profile}),console.log("[AdminService] âœ… Business topic fallback: Found ".concat(m.length,' users with topic "').concat(n,'"')),m.length===0){try{console.log('[AdminService] Trying attribute endpoint for business topic "'.concat(n,'"...'));const e=await this.getUsersByAttribute(s,"business_topic",n,u);if(e&&e.length>0)return console.log("[AdminService] âœ… Attribute endpoint found ".concat(e.length,' users for business topic "').concat(n,'"')),e;console.log('[AdminService] âš ï¸ Attribute endpoint returned 0 users for business topic "'.concat(n,'"'))}catch(e){const h=(e==null?void 0:e.status)||((d=e==null?void 0:e.response)==null?void 0:d.status);console.error('[AdminService] âŒ Attribute endpoint failed for business_topic "'.concat(n,'":'),{status:h,message:e==null?void 0:e.message,response:(o=e==null?void 0:e.response)==null?void 0:o.data})}try{console.log("[AdminService] Trying to get business topic users via community members endpoint...");const e="/communities/".concat(s,"/members?onlyActive=").concat(u);try{const h=await T.get(e);console.log("[AdminService] Got ".concat((h==null?void 0:h.length)||0," members, but business topics aren't in member data"))}catch(h){console.log("[AdminService] Members endpoint not available or failed")}}catch(e){console.warn("[AdminService] Member query approach failed:",e)}try{console.log('[AdminService] Profile-based filtering found 0 users for business topic "'.concat(n,'", trying unconsolidated endpoint recovery...'));const e=await this.getBusinessTopicsChartData(s,!1,u);console.log("[AdminService] Got ".concat(e.length," rows from unconsolidated business topics endpoint")),e.length>0&&console.log("[AdminService] ðŸ” First 3 rows from unconsolidated business topics:",e.slice(0,3).map((h,a)=>({index:a,fullRow:h,keys:Object.keys(h),name:h==null?void 0:h.name,label:h==null?void 0:h.label,value:h==null?void 0:h.value,count:h==null?void 0:h.count}))),console.log("[AdminService] âš ï¸ Unconsolidated endpoint returns aggregated data without user IDs. Need backend endpoint fix.")}catch(e){console.warn("[AdminService] Business topic unconsolidated endpoint recovery failed:",e)}console.error('[AdminService] âŒ Cannot retrieve users for business topic "'.concat(n,'" - backend endpoint returns 500 error and unconsolidated data is aggregated without user IDs.')),console.error('[AdminService] The backend SQL query is failing: "could not identify an equality operator for type json"'),console.error("[AdminService] This indicates data_business_topic.name is a JSON field and needs proper JSON query syntax.")}return m}catch(p){return console.error("Error in fallback business topic filtering:",p),[]}}async getUsersByCustomField(s,n,u,d=!0){var o,p;try{const f="/communities/".concat(s,"/attribute/users?type=custom&customFieldId=").concat(n,"&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d,"&limit=200"),t=await T.get(f);let m,e=null;if(Array.isArray(t)?m=t:t&&Array.isArray(t.data)?(m=t.data,e=t.pagination):(console.warn("[AdminService] Unexpected response format for custom field ".concat(n,":").concat(u)),m=[]),!m||m.length===0)return[];if(e&&e.totalPages>1){const a=[...m],i=e.totalPages||1,c=e.currentPage||1;for(let r=c+1;r<=i;r++)try{const l="/communities/".concat(s,"/attribute/users?type=custom&customFieldId=").concat(n,"&value=").concat(encodeURIComponent(u),"&onlyActive=").concat(d,"&limit=200&page=").concat(r),v=await T.get(l),g=Array.isArray(v)?v:(v==null?void 0:v.data)||[];a.push(...g)}catch(l){console.warn("[AdminService] Failed to load page ".concat(r," for custom field ").concat(n,":").concat(u,":"),l)}m=a}return m.map(a=>({id:a.id||a.userId,userId:a.userId||a.id,fname:a.fname||"",lname:a.lname||"",fullName:a.fullName||"".concat(a.fname||""," ").concat(a.lname||"").trim(),email:a.email||"",profilePicture:a.profilePicture,bio:a.bio,pronouns:a.pronouns,isManager:a.isManager,enabled:a.enabled,joinDate:a.joinDate,...a}))}catch(f){const t=(f==null?void 0:f.status)||((o=f==null?void 0:f.response)==null?void 0:o.status);return t===404?[]:(console.error("[AdminService] Error fetching users for custom field ".concat(n,":").concat(u,":"),{status:t,message:f==null?void 0:f.message,response:(p=f==null?void 0:f.response)==null?void 0:p.data}),[])}}verifyConsolidatedData(s,n){if(!s||s.length===0)return;const u=s.filter(d=>{const o=d.name||"";return!!(o.includes("|")||o.includes(":")&&o.split(":").length>2)});u.length>0?(console.warn("[AdminService] âš ï¸ Potential issue: ".concat(n," data appears to contain per-user responses instead of consolidated data."),"Found ".concat(u.length," items with suspicious patterns:"),u.slice(0,3)),console.warn('[AdminService] Expected format: [{ name: "ChatGPT", value: 5 }] (cumulative count)',"Found format: Items with pipe-separated or user-specific values")):s.filter(o=>o.value===1).length===s.length&&s.length>1?console.warn("[AdminService] âš ï¸ Potential issue: All ".concat(n," data items have value=1."),"This might indicate per-user data instead of consolidated counts."):console.log("[AdminService] âœ“ ".concat(n," data appears to be properly consolidated."),"Total items: ".concat(s.length,", Total count: ").concat(s.reduce((o,p)=>o+p.value,0)))}async getUserStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/users");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?(console.log("[AdminService] Stats endpoint not found for community ".concat(s)),null):(console.error("Failed to fetch user stats:",o),null)}}async getEngagementStats(s,n,u){const d=T.get("/communities/".concat(s,"/stats/engagement").concat(n&&u?"?startDate=".concat(n,"&endDate=").concat(u):"")).catch(p=>{var f;if((p==null?void 0:p.status)===404||((f=p==null?void 0:p.response)==null?void 0:f.status)===404)return null;throw p}),o=this.calculateEngagementStatsFromData(s,n,u);try{const[p,f]=await Promise.allSettled([d,o]);return p.status==="fulfilled"&&p.value?p.value:f.status==="fulfilled"&&f.value?f.value:null}catch(p){console.error("[AdminService] Error getting engagement stats:",p);try{return await this.calculateEngagementStatsFromData(s,n,u)}catch(f){return console.error("[AdminService] Error calculating stats:",f),null}}}async calculateEngagementStatsFromData(s,n,u){var d,o,p,f,t,m,e,h,a,i,c,r,l;try{const v=n?new Date(n):null,g=u?new Date(u):null,[S,A,$,U]=await Promise.allSettled([this.getProfilesForCommunity(s),this.getEventsForCommunity(s),this.getGroupsForCommunity(s),this.getMatchesForCommunity(s,n,u)]);U.status==="rejected"&&console.error("[AdminService] Matches fetch failed:",U.reason);const _={totalUsers:0,activeUsers:0,newUsersThisMonth:0,profilesCreated:0,connectionsMade:0,trovaChatsStarted:0,totalMessagesSent:0,eventsCreated:0,eventsAttended:0,groupsCreated:0,groupsJoined:0,dailyActiveUsers:0,weeklyActiveUsers:0,profileCompletionRate:0,matchResponseRate:0};if(S.status==="fulfilled"){const M=S.value||[];console.log("[AdminService] Fetched ".concat(M.length," profiles for community ").concat(s)),_.profilesCreated=M.length,_.totalUsers=M.length,console.log("[AdminService] Calculated ".concat(M.length," profiles for community ").concat(s," (date filtering not available - ProfilesInit has no createdAt field)"));let y=0;M.forEach(C=>{const b=C.bio&&typeof C.bio=="string"&&C.bio.trim().length>0,w=C.interests&&Array.isArray(C.interests)&&C.interests.length>0,I=C.locations&&Array.isArray(C.locations)&&C.locations.length>0||C.currentLocationName&&C.currentLocationName.trim().length>0;(b||w||I)&&y++}),_.profileCompletionRate=M.length>0?y/M.length*100:0,_.profileCompletionCompleted=y,_.profileCompletionTotal=M.length,console.log("[AdminService] Profile completion: ".concat(y,"/").concat(M.length," (").concat(_.profileCompletionRate.toFixed(1),"%)"))}else{const M=S.status==="rejected"?S.reason:"unknown";console.warn("[AdminService] Profiles fetch failed:",M),S.status==="rejected"&&console.error("[AdminService] Profiles error details:",M)}if(A.status==="fulfilled"){const M=A.value||[];let y=0,C=0,b=0,w=0;M.forEach((I,k)=>{if(!v&&!g)y++,I.attendeeCount!==void 0&&I.attendeeCount!==null?C+=I.attendeeCount:I.attendees&&Array.isArray(I.attendees)&&(C+=I.attendees.length);else{const P=I.startDateTimeUTC||I.startDate;if(P){const F=new Date(P);isNaN(F.getTime())?(w++,k<3&&console.error('[AdminService] ðŸ“… Event "'.concat(I.name,'" has invalid date: ').concat(P))):(!v||F>=v)&&(!g||F<=g)?(y++,I.attendeeCount!==void 0&&I.attendeeCount!==null?C+=I.attendeeCount:I.attendees&&Array.isArray(I.attendees)&&(C+=I.attendees.length)):(b++,k<3&&console.error('[AdminService] ðŸ“… Event "'.concat(I.name,'" excluded: date ').concat(F.toISOString()," not in range ").concat(v==null?void 0:v.toISOString()," to ").concat(g==null?void 0:g.toISOString())))}else w++,k<3&&console.error('[AdminService] ðŸ“… Event "'.concat(I.name,'" has no date field (startDate/startDateTimeUTC)')),y++,I.attendeeCount!==void 0&&I.attendeeCount!==null?C+=I.attendeeCount:I.attendees&&Array.isArray(I.attendees)&&(C+=I.attendees.length)}}),_.eventsCreated=y,_.eventsAttended=C}if($.status==="fulfilled"){const M=$.value||[];let y=0,C=0,b=0,w=0;const I=new Set;M.forEach((k,P)=>{if(!v&&!g)y++,k.memberCount!==void 0&&k.memberCount!==null?C+=k.memberCount:k.users&&Array.isArray(k.users)&&(C+=k.users.length,k.users.forEach(F=>{F.id&&I.add(F.id)}));else if(k.createdAt){const F=new Date(k.createdAt);isNaN(F.getTime())?(w++,P<3&&console.error('[AdminService] ðŸ‘¥ Group "'.concat(k.name,'" has invalid createdAt: ').concat(k.createdAt))):(!v||F>=v)&&(!g||F<=g)?(y++,k.memberCount!==void 0&&k.memberCount!==null?C+=k.memberCount:k.users&&Array.isArray(k.users)&&(C+=k.users.length,k.users.forEach(E=>{E.id&&I.add(E.id)}))):(b++,P<3&&console.error('[AdminService] ðŸ‘¥ Group "'.concat(k.name,'" excluded: date ').concat(F.toISOString()," not in range ").concat(v==null?void 0:v.toISOString()," to ").concat(g==null?void 0:g.toISOString())))}else w++,P<3&&console.error('[AdminService] ðŸ‘¥ Group "'.concat(k.name,'" has no createdAt field')),y++,k.memberCount!==void 0&&k.memberCount!==null?C+=k.memberCount:k.users&&Array.isArray(k.users)&&(C+=k.users.length,k.users.forEach(F=>{F.id&&I.add(F.id)}))}),_.groupsCreated=y,_.groupsJoined=I.size>0?I.size:C}else $.status==="rejected"&&console.warn("[AdminService] Groups fetch failed:",$.reason);if(U.status==="fulfilled"){const M=U.value||[];M.length===0&&console.warn("[AdminService] No matches returned from endpoint");let y=M;if(M.length>0){const w=M[0];if(w.communityId!==void 0||w.community_id!==void 0){const I=w.communityId!==void 0?"communityId":"community_id";y=M.filter(k=>(k.communityId||k.community_id)===s),console.log("[AdminService] Filtered by ".concat(I,": ").concat(y.length," matches for community ").concat(s))}else console.log("[AdminService] Matches already filtered by endpoint middleware, using all matches"),y=M}let C=0,b=!1;try{console.log("[AdminService] ðŸ”— Fetching connections count from backend endpoint...");const w=[];n&&w.push("startDate=".concat(encodeURIComponent(n))),u&&w.push("endDate=".concat(encodeURIComponent(u)));const I=w.length?"?".concat(w.join("&")):"",k="/communities/".concat(s,"/connections-count").concat(I),P=await T.get(k);P&&typeof P.connectionsMade=="number"&&(P.connectionsMade===0&&y&&y.length>0?console.warn("[AdminService] âš ï¸ Backend returned 0 connections but we have ".concat(y.length," matches - using client-side calculation")):(C=P.connectionsMade,b=!0,console.log("[AdminService] âœ… Connections count from backend: ".concat(C))))}catch(w){(w==null?void 0:w.status)===404||((d=w==null?void 0:w.response)==null?void 0:d.status)===404?console.log("[AdminService] Connections count endpoint not found, using client-side calculation"):console.warn("[AdminService] Failed to fetch connections count from backend, using client-side calculation:",w)}if(!b){const w=new Map;y.forEach(E=>{const N=E.groupId||E.group_id||(E.matchIndicesId&&E.matchIndicesId!==0?E.matchIndicesId:null);if(N!=null){const R=String(N);w.has(R)||w.set(R,new Set);const D=w.get(R);E.userId!==void 0&&E.userId!==null&&D.add(E.userId),E.matchedUserId!==void 0&&E.matchedUserId!==null&&D.add(E.matchedUserId)}});const I=new Set;w.forEach((E,N)=>{const D=Array.from(E).sort((B,q)=>B-q).join(",");I.add(D)});let k=I.size;if(k===0){const E=new Set;y.forEach(N=>{if(N.userId!==void 0&&N.matchedUserId!==void 0){const R=[N.userId,N.matchedUserId].sort().join("-");E.add(R)}}),k=E.size}console.log("[AdminService] Found ".concat(k," unique connections (unique sets of people) from ").concat(y.length," match records")),console.log("[AdminService] Note: ".concat(y.length," total match records = ").concat(y.length," intros, but only ").concat(k," unique connections (unique sets of people)"));let P=k,F=0,j=0;if(v||g){const E=y.filter(D=>{const B=D.createdAt||D.created_at;if(B){const q=new Date(B);if(isNaN(q.getTime()))return j++,!1;{const z=(!v||q>=v)&&(!g||q<=g);return z||F++,z}}else return j++,!1});console.error("[AdminService] ðŸ”— After date filter: ".concat(E.length," matches in range, ").concat(F," excluded, ").concat(j," with no/invalid date"));const N=new Map;E.forEach(D=>{const B=D.groupId||D.group_id||(D.matchIndicesId&&D.matchIndicesId!==0?D.matchIndicesId:null);if(B!=null){const q=String(B);N.has(q)||N.set(q,new Set);const z=N.get(q);D.userId!==void 0&&D.userId!==null&&z.add(D.userId),D.matchedUserId!==void 0&&D.matchedUserId!==null&&z.add(D.matchedUserId)}});const R=new Set;N.forEach(D=>{const q=Array.from(D).sort((z,Y)=>z-Y).join(",");R.add(q)}),P=R.size>0?R.size:0,console.error("[AdminService] ðŸ”— After date filter: ".concat(P," unique connections"))}else console.error("[AdminService] ðŸ”— No date filter applied - using all ".concat(y.length," matches"));C=P,console.error("[AdminService] ðŸ”— Final (client-side): ".concat(C," unique connections (from ").concat(y.length," match records, ").concat(F," excluded by date, ").concat(j," with no date)"))}_.connectionsMade=C;try{const w=await this.calculateMatchResponseRate(s,y,n,u);_.matchResponseRate=w}catch(w){console.warn("[AdminService] Could not calculate match response rate:",w),_.matchResponseRate=0}}else U.status==="rejected"&&(console.error("[AdminService] Matches fetch failed:",U.reason),_.connectionsMade=0);try{const M=await this.getMessageStats(s,n,u);M&&(_.totalMessagesSent=M.totalMessagesSent)}catch(M){console.error("[AdminService] Error calculating message stats:",M)}try{const M=await this.getActiveUserStats(s,n,u);M&&(_.dailyActiveUsers=M.dailyActiveUsers,_.weeklyActiveUsers=M.weeklyActiveUsers)}catch(M){console.error("[AdminService] Error calculating active user stats:",M)}try{const M=await this.calculateMatchEngagementStats(s,n,u);M?Object.assign(_,M):(console.error("[AdminService] âš ï¸âš ï¸âš ï¸ calculateMatchEngagementStats returned null/undefined - initializing to 0"),_.channelPairingMatches=(o=_.channelPairingMatches)!=null?o:0,_.channelPairingEngagements=(p=_.channelPairingEngagements)!=null?p:0,_.mentorMenteeMatches=(f=_.mentorMenteeMatches)!=null?f:0,_.mentorMenteeUniquePairs=(t=_.mentorMenteeUniquePairs)!=null?t:0,_.trovaMagicMatches=(m=_.trovaMagicMatches)!=null?m:0,_.trovaMagicEngagements=(e=_.trovaMagicEngagements)!=null?e:0)}catch(M){console.error("[AdminService] Could not calculate match engagement stats:",M),_.channelPairingMatches=(h=_.channelPairingMatches)!=null?h:0,_.channelPairingEngagements=(a=_.channelPairingEngagements)!=null?a:0,_.mentorMenteeMatches=(i=_.mentorMenteeMatches)!=null?i:0,_.mentorMenteeUniquePairs=(c=_.mentorMenteeUniquePairs)!=null?c:0,_.trovaMagicMatches=(r=_.trovaMagicMatches)!=null?r:0,_.trovaMagicEngagements=(l=_.trovaMagicEngagements)!=null?l:0}return _}catch(v){return console.error("[AdminService] Error calculating engagement stats:",v),null}}async getProfilesForCommunity(s){try{const{profileService:n}=await L(()=>import("./profile.service-CDoO2DLV.js"),__vite__mapDeps([0,1,2]));return await n.getProfilesForUserAndCommunity(s)}catch(n){return console.warn("[AdminService] Could not fetch profiles:",n),[]}}async getEventsForCommunity(s){var n;try{const{eventService:u}=await L(()=>import("./event.service-D7cjacjh.js"),__vite__mapDeps([3,1,2])),{useAuthStore:d}=await L(()=>import("./index-CkJ7yJ3n.js").then(p=>p.bW),__vite__mapDeps([1,2])),o=d();return(n=o.user)!=null&&n.id?await u.getEvents(s,o.user.id):[]}catch(u){return console.warn("[AdminService] Could not fetch events:",u),[]}}async getGroupsForCommunity(s){var n;try{const{groupService:u}=await L(()=>import("./group.service-CH2Rgjsj.js"),__vite__mapDeps([4,1,2])),{useAuthStore:d}=await L(()=>import("./index-CkJ7yJ3n.js").then(p=>p.bW),__vite__mapDeps([1,2])),o=d();return(n=o.user)!=null&&n.id?await u.getGroups(s,o.user.id):[]}catch(u){return console.warn("[AdminService] Could not fetch groups:",u),[]}}async getMatchesForCommunity(s,n,u,d){this.clearExpiredCache();const o=this.getMatchesCacheKey(s,n,u,d),p=this.matchesCache.get(o);if(p&&this.isCacheValid(p.timestamp))return console.log("[AdminService] âœ… Using cached matches for ".concat(o," (").concat(p.data.length," matches)")),p.data;const f=this.pendingRequests.get(o);if(f)return console.log("[AdminService] â³ Reusing pending request for ".concat(o)),f;console.log("[AdminService] ðŸ” Fetching matches for community ".concat(s),{startDate:n,endDate:u,type:d});const t=this.fetchMatchesForCommunity(s,n,u,d,o);this.pendingRequests.set(o,t);try{return await t}finally{this.pendingRequests.delete(o)}}async fetchMatchesForCommunity(s,n,u,d,o){var h,a;const p=new URLSearchParams;n&&p.append("startDate",n),u&&p.append("endDate",u),d&&p.append("type",d);const f=p.toString(),m=[{url:"/communities/".concat(s,"/matches").concat(f?"?".concat(f):""),name:"/communities/".concat(s,"/matches").concat(f?"?".concat(f):"")},{url:"/matches?communityId=".concat(s),name:"/matches?communityId=".concat(s)},{url:"/matches",name:"/matches (middleware - user's session community)",useHeader:!0}];for(const i of m)try{console.log("[AdminService] ðŸ“¡ Trying GET ".concat(i.name,"..."));const c=i.useHeader?{headers:{"X-Community-Id":String(s)}}:void 0,r=await T.get(i.url,c);if(console.log("[AdminService] âœ… Fetched ".concat((r==null?void 0:r.length)||0," matches from ").concat(i.name)),r&&r.length>0){let v=r;return(r[0].communityId!==void 0||r[0].community_id!==void 0)&&(v=v.filter(g=>(g.communityId||g.community_id)===s),v.length!==r.length&&console.log("[AdminService] âš ï¸ Endpoint returned ".concat(r.length," matches, but only ").concat(v.length," are for community ").concat(s))),o&&this.matchesCache.set(o,{data:v,timestamp:Date.now()}),v}else if(r&&r.length===0&&(console.log("[AdminService] âš ï¸ ".concat(i.name," returned empty array (0 matches)")),o&&this.matchesCache.set(o,{data:[],timestamp:Date.now()}),i.url!=="/matches"))continue;const l=r||[];return o&&this.matchesCache.set(o,{data:l,timestamp:Date.now()}),l}catch(c){if(((h=c.response)==null?void 0:h.status)===404){console.log("[AdminService] âš ï¸ ".concat(i.name," returned 404, trying next endpoint..."));continue}console.warn("[AdminService] âš ï¸ ".concat(i.name," failed:"),((a=c.response)==null?void 0:a.status)||c.message);continue}console.warn("[AdminService] âŒ All match endpoints failed or returned 0 matches");const e=[];return o&&this.matchesCache.set(o,{data:e,timestamp:Date.now()}),e}async getUserActionsStats(s,n,u){var e,h,a,i;const d=n&&u?"startDate=".concat(n,"&endDate=").concat(u):"",o=d?"?".concat(d):"",p=d?"&".concat(d):"",f=["/communities/".concat(s,"/slack-user-stats").concat(o),"/communities/".concat(s,"/stats/user-actions").concat(o),"/communities/".concat(s,"/user-actions").concat(o),"/communities/".concat(s,"/stats/userActions").concat(o),"/console/user-actions?communityId=".concat(s).concat(p),"/console/stats/user-actions?communityId=".concat(s).concat(p),"/console/stats/userActions?communityId=".concat(s).concat(p),"/console/communities/".concat(s,"/user-actions").concat(o),"/console/communities/".concat(s,"/stats/user-actions").concat(o),"/stats/user-actions?communityId=".concat(s).concat(p),"/api/console/user-actions?communityId=".concat(s).concat(p)];for(const c of f)try{const r=await T.get(c);if(r&&r.rows&&Array.isArray(r.rows)){console.log("[AdminService] ðŸ“Š Processing slack-user-stats format with ".concat(r.rows.length," rows")),console.log("[AdminService] ðŸ“Š Response structure:",{hasRows:!!r.rows,rowCount:(e=r.rows)==null?void 0:e.length,hasColumns:!!r.columns,totalUserCount:r.totalUserCount,sampleRow:(h=r.rows)==null?void 0:h[0]});const l=this.aggregateSlackUserStats(r);if(l)return console.log("[AdminService] âœ… User actions stats aggregated from slack-user-stats (using backend introsLedToConvos):",l),l;console.warn("[AdminService] âš ï¸ aggregateSlackUserStats returned null, continuing to next endpoint")}if(r&&typeof r=="object"&&!r.rows){const l=r;if(l&&Object.keys(l).length>0){if(l.introsLedToConvos===void 0||l.introsLedToConvos===null){console.log("[AdminService] Backend didn't provide introsLedToConvos, calculating from matches...");const g=await this.calculateIntrosLedToConvos(s,n,u);l.introsLedToConvos=g}else console.log("[AdminService] Using introsLedToConvos from backend: ".concat(l.introsLedToConvos));if(Object.values(l).some(g=>typeof g=="number"&&g>0)||Object.keys(l).length>0)return console.log("[AdminService] âœ… User actions stats fetched from: ".concat(c),l),l;console.log("[AdminService] âš ï¸ Endpoint ".concat(c," returned empty stats, trying next..."))}}}catch(r){const l=(r==null?void 0:r.status)||((a=r==null?void 0:r.response)==null?void 0:a.status);l===404||console.warn("[AdminService] Error fetching user actions from ".concat(c,":"),{status:l,message:r==null?void 0:r.message,response:(i=r==null?void 0:r.response)==null?void 0:i.data})}const t=await this.calculateUserActionsStats(s,n,u);if(t){if(t.introsLedToConvos===void 0||t.introsLedToConvos===null){const c=await this.calculateIntrosLedToConvos(s,n,u);t.introsLedToConvos=c}return t}return{openedTrova:0,generalActions:0,spotlightsCreated:0,recWallsGiven:0,recWallsReceived:0,introsLedToConvos:await this.calculateIntrosLedToConvos(s,n,u)}}async calculateIntrosLedToConvos(s,n,u){try{let d=0;try{d=(await this.getMagicIntrosByDate(s,n,u)).filter(h=>h.totalPairings<=1e3).reduce((h,a)=>h+a.engagedPairings,0)}catch(m){console.warn("[AdminService] Could not fetch Trova Magic engaged count:",m)}let o=0;try{const m=await this.getMatchesForCommunity(s,n,u,"channel_pairing");if(m&&m.length>0){const e=new Set;for(const h of m){const a=h.groupId||h.group_id||(h.matchIndicesId&&h.matchIndicesId!==0?h.matchIndicesId:null);a!=null&&e.add(a)}e.size>0&&(o=await this.countEngagedMatchesByGroup(s,m,e))}}catch(m){console.warn("[AdminService] Could not calculate Channel Pairing engaged count:",m)}let p=0,f=0;try{const m=await this.getMatchesForCommunity(s,n,u,"mentor-mentee");if(m&&m.length>0){const e=new Set,h=new Map,a=await this.getConversationPairs(s);for(const i of m){const c=i.userId||i.user_id,r=i.matchedUserId||i.matched_user_id;if(c&&r){const l=[c,r].sort((v,g)=>v-g).join("-");if(!e.has(l)){e.add(l);const v=a.has(l);h.set(l,{userId:c,matchedUserId:r,isEngaged:v}),v&&p++}}}f=e.size,console.log("[AdminService] ðŸŽ“ Mentor/Mentee breakdown:"),console.log("[AdminService]   - Total match records: ".concat(m.length)),console.log("[AdminService]   - Unique pairs: ".concat(f)),console.log("[AdminService]   - Engaged pairs: ".concat(p)),f>0&&f<10&&console.log("[AdminService]   - Pair details:",Array.from(h.entries()).map(([i,c])=>"".concat(c.userId,"-").concat(c.matchedUserId," (engaged: ").concat(c.isEngaged,")")))}}catch(m){console.warn("[AdminService] Could not calculate Mentor/Mentee engaged count:",m)}const t=d+o+p;return console.log("[AdminService] ðŸ’¬ Intros Led To Convos breakdown (unique pairs/groups):"),console.log("[AdminService]   - Trova Magic: ".concat(d," engaged unique pairs")),console.log("[AdminService]   - Channel Pairing: ".concat(o," engaged unique groups")),console.log("[AdminService]   - Mentor/Mentee: ".concat(p," engaged unique pairs (out of ").concat(f," total unique pairs)")),console.log("[AdminService]   - TOTAL: ".concat(t," (sum of engaged unique pairs/groups)")),t}catch(d){return console.warn("[AdminService] Could not calculate Intros Led To Convos:",d),0}}aggregateSlackUserStats(s){if(!s.rows||!Array.isArray(s.rows))return console.warn("[AdminService] âš ï¸ aggregateSlackUserStats: response.rows is missing or not an array, returning zeros"),{openedTrova:0,generalActions:0,spotlightsCreated:0,recWallsGiven:0,recWallsReceived:0,introsLedToConvos:0,trovaMagicEngagements:0,channelPairingOnDemand:0,channelPairingCadence:0};if(s.rows.length===0)return console.log("[AdminService] ðŸ“Š aggregateSlackUserStats: No rows found, returning zeros"),{openedTrova:0,generalActions:0,spotlightsCreated:0,recWallsGiven:0,recWallsReceived:0,introsLedToConvos:0,trovaMagicEngagements:0,channelPairingOnDemand:0,channelPairingCadence:0};const n={},u=s.rows;let d=0,o=0,p=0,f=0,t=0,m=0,e=0,h=0,a=0;return u.forEach(i=>{const c=this.getNumericValue(i,["homepageViews","openedTrova","opened_trova","Opened Trova"]);d+=c,o+=this.getNumericValue(i,["profileActions","generalActions","general_actions","General Actions"]),p+=this.getNumericValue(i,["spotlightsCreated","spotlights_created","Spotlights Created"]),f+=this.getNumericValue(i,["recWallsGiven","rec_walls_given","Rec Walls Given"]),t+=this.getNumericValue(i,["recWallsReceived","rec_walls_received","Rec Walls Received"]),m+=this.getNumericValue(i,["introsLedToConvos","intros_led_to_convos","Intros Led To Convos"]),e+=this.getNumericValue(i,["introsAttributedToTrovaMagic","intros_attributed_to_trova_magic","Trova Magic"]),h+=this.getNumericValue(i,["introsAttributedToChannelPairingOnDemand","intros_attributed_to_channel_pairing_on_demand","Channel Pairing On Demand"]),a+=this.getNumericValue(i,["introsAttributedToChannelPairingCadence","intros_attributed_to_channel_pairing_cadence","Channel Pairing Cadence"])}),n.openedTrova=d,n.generalActions=o,n.spotlightsCreated=p,n.recWallsGiven=f,n.recWallsReceived=t,n.introsLedToConvos=m,n.trovaMagicEngagements=e,n.channelPairingOnDemand=h,n.channelPairingCadence=a,(n.openedTrova===void 0||n.openedTrova===null)&&(n.openedTrova=0),console.log("[AdminService] ðŸ“Š Aggregated stats from ".concat(u.length," rows:"),{openedTrova:d,generalActions:o,spotlightsCreated:p,recWallsGiven:f,recWallsReceived:t,introsLedToConvos:m,trovaMagicEngagements:e,channelPairingOnDemand:h,channelPairingCadence:a}),u.length>0,n}getNumericValue(s,n){for(const u of n){const d=s[u];if(typeof d=="number")return d;if(typeof d=="string"){const o=parseFloat(d);if(!isNaN(o))return o}}return 0}async calculateUserActionsStats(s,n,u){var d;try{console.log("[AdminService] ðŸ“Š Calculating user actions stats for community ".concat(s));const o={},p=n&&u?"startDate=".concat(n,"&endDate=").concat(u):"",f=p?"?".concat(p):"",t=p?"&".concat(p):"",m=["/communities/".concat(s,"/user-events").concat(f),"/communities/".concat(s,"/events/user").concat(f),"/user-events?communityId=".concat(s).concat(t),"/console/user-events?communityId=".concat(s).concat(t),"/console/communities/".concat(s,"/user-events").concat(f),"/console/events/user?communityId=".concat(s).concat(t),"/api/user-events?communityId=".concat(s).concat(t),"/events/user?communityId=".concat(s).concat(t)];let e=[];for(const h of m)try{const a=await T.get(h);if(a&&Array.isArray(a)){e=a,console.log("[AdminService] âœ… Found ".concat(e.length," user events from ").concat(h));break}}catch(a){(a==null?void 0:a.status)!==404&&((d=a==null?void 0:a.response)==null?void 0:d.status)!==404&&console.warn("[AdminService] Error fetching user events from ".concat(h,":"),a)}if(e.length>0){const h=n?new Date(n):null,a=u?new Date(u):null;let i=0,c=0,r=0,l=0,v=0;e.forEach(g=>{if(h||a){const $=g.createdAt||g.timestamp||g.date;if($){const U=new Date($);if(h&&U<h||a&&U>a)return}}const S=g.type||g.eventType||g.action,A=g.name||g.eventName||"";S==="opened_trova"||A.toLowerCase().includes("opened trova")||A.toLowerCase().includes("open trova")?c++:S==="spotlight"||S==="spotlight_created"||A.toLowerCase().includes("spotlight")?r++:S==="rec_wall"||S==="rec_wall_given"||A.toLowerCase().includes("rec wall given")?l++:S==="rec_wall_received"||A.toLowerCase().includes("rec wall received")?v++:i++}),o.generalActions=i,o.openedTrova=c,o.spotlightsCreated=r,o.recWallsGiven=l,o.recWallsReceived=v,console.log("[AdminService] ðŸ“Š User actions calculated:",{generalActions:i,openedTrova:c,spotlightsCreated:r,recWallsGiven:l,recWallsReceived:v})}else o.generalActions=0,o.openedTrova=0,o.spotlightsCreated=0,o.recWallsGiven=0,o.recWallsReceived=0,console.warn("[AdminService] No user events found, returning zeros");return o}catch(o){return console.error("[AdminService] Error calculating user actions stats:",o),{generalActions:0,openedTrova:0,spotlightsCreated:0,recWallsGiven:0,recWallsReceived:0}}}async calculateUniqueIntroductionsPerUser(s,n,u){const d=new Map;try{const o=["trova_magic","channel_pairing","mentor-mentee"],p=new Map;for(const t of o)try{const m=await this.getMatchesForCommunity(s,n,u,t);if(m&&m.length>0)if(t==="channel_pairing")for(const e of m){const h=e.userId||e.user_id,a=e.matchedUserId||e.matched_user_id,i=e.groupId||e.group_id||(e.matchIndicesId&&e.matchIndicesId!==0?e.matchIndicesId:null);i&&(p.has(i)||p.set(i,new Set),h&&p.get(i).add(h),a&&p.get(i).add(a))}else for(const e of m){const h=e.userId||e.user_id,a=e.matchedUserId||e.matched_user_id;h&&a&&(d.has(h)||d.set(h,new Set),d.get(h).add(a))}}catch(m){console.warn("[AdminService] Error fetching ".concat(t," matches for unique introductions:"),m)}for(const[t,m]of p.entries()){const e=Array.from(m);for(let h=0;h<e.length;h++){const a=e[h];d.has(a)||d.set(a,new Set);for(let i=0;i<e.length;i++)h!==i&&d.get(a).add(e[i])}}const f=new Map;for(const[t,m]of d.entries())f.set(t,m.size);if(console.log("[AdminService] âœ… Calculated unique introductions for ".concat(f.size," users")),f.size>0){const t=Array.from(f.entries()).slice(0,5);console.log("[AdminService] Sample unique intro counts:",t)}return f}catch(o){return console.error("[AdminService] Error calculating unique introductions per user:",o),new Map}}async getSlackUserStats(s,n,u){var f,t;const d=[];n&&d.push("startDate=".concat(encodeURIComponent(n))),u&&d.push("endDate=".concat(encodeURIComponent(u)));const o=d.length?"?".concat(d.join("&")):"",p="/communities/".concat(s,"/slack-user-stats").concat(o);try{console.log("[AdminService] Fetching slack-user-stats: ".concat(p));const m=await T.get(p);if(m&&Array.isArray(m.rows)){console.log("[AdminService] Calculating unique introductions per user...");const e=await this.calculateUniqueIntroductionsPerUser(s,n,u);return{rows:m.rows.map(a=>{const i=a.userId||a.user_id||a.id,c=i&&e.get(i)||0;return{...a,introsLedToConvos:c}}),columns:m.columns||[],totalUserCount:m.totalUserCount||((f=m.rows)==null?void 0:f.length)||0}}}catch(m){console.error("[AdminService] Failed to fetch slack-user-stats:",m);try{console.log("[AdminService] Attempting fallback: fetching user actions stats...");const h=await this.getUserActionsStats(s,n,u);if(h&&h.openedTrova&&h.openedTrova>0)return console.log("[AdminService] Fallback found openedTrova stats, but no per-user data available"),{rows:[],columns:[],totalUserCount:0,error:"Backend server error. User statistics are available, but per-user details cannot be loaded. Please try again later."}}catch(h){console.error("[AdminService] Fallback also failed:",h)}const e=((t=m==null?void 0:m.response)==null?void 0:t.status)===500?"Backend server error. Please try again later.":(m==null?void 0:m.message)||"Failed to fetch user statistics.";return{rows:[],columns:[],totalUserCount:0,error:e}}return{rows:[],columns:[],totalUserCount:0}}async getSkillsStats(s){var o,p;const n=["/communities/".concat(s,"/stats/skills"),"/communities/".concat(s,"/skills/stats"),"/console/stats/skills?communityId=".concat(s),"/console/skills/stats?communityId=".concat(s),"/console/communities/".concat(s,"/stats/skills"),"/stats/skills?communityId=".concat(s),"/api/console/stats/skills?communityId=".concat(s)];for(const f of n)try{console.log("[AdminService] ðŸŽ“ Trying skills stats endpoint: ".concat(f));const t=await T.get(f);if(t&&Object.keys(t).length>0)if(Object.values(t).some(e=>typeof e=="number"&&e>0)||Object.keys(t).length>0){if(console.log("[AdminService] âœ… Skills stats fetched from: ".concat(f),t),t.usersCanMentor===void 0||t.usersWantMentor===void 0){const e=await this.getMentorMenteeStats(s);e&&(e.usersCanMentor!==void 0&&(t.usersCanMentor=e.usersCanMentor),e.usersWantMentor!==void 0&&(t.usersWantMentor=e.usersWantMentor))}return t}else console.log("[AdminService] âš ï¸ Endpoint ".concat(f," returned empty stats, trying next..."))}catch(t){const m=(t==null?void 0:t.status)||((o=t==null?void 0:t.response)==null?void 0:o.status);m===404||console.warn("[AdminService] Error fetching skills from ".concat(f,":"),{status:m,message:t==null?void 0:t.message,response:(p=t==null?void 0:t.response)==null?void 0:p.data})}console.log("[AdminService] All skills endpoints failed, trying client-side calculation");const u=await this.calculateSkillsStats(s),d=await this.getMentorMenteeStats(s);return d&&u&&(d.usersCanMentor!==void 0&&(u.usersCanMentor=d.usersCanMentor),d.usersWantMentor!==void 0&&(u.usersWantMentor=d.usersWantMentor)),u}async getWeeklyIntroductionsStats(s){var n,u,d,o,p;try{const f="/communities/".concat(s,"/stats/weekly-introductions");console.log("[AdminService] ðŸ“§ Fetching weekly introductions stats: ".concat(f));const t=await T.get(f);if(t&&typeof t=="object"){const m=(n=t.usersIntroducedLast12Mo)!=null?n:0,e=(u=t.usersIntroducedThisYear)!=null?u:0;return console.log("[AdminService] âœ… Weekly introductions stats fetched for community ".concat(s,":"),{usersIntroducedLast12Mo:m,usersIntroducedThisYear:e}),{userOnboardingIntros:m}}return console.warn("[AdminService] Weekly introductions stats endpoint returned invalid response for community ".concat(s)),null}catch(f){const t=(f==null?void 0:f.status)||((d=f==null?void 0:f.response)==null?void 0:d.status);return t===404?console.log("[AdminService] Weekly introductions stats endpoint not found for community ".concat(s," (404)")):t===500?console.warn("[AdminService] Weekly introductions stats endpoint returned 500 error for community ".concat(s,":"),((o=f==null?void 0:f.response)==null?void 0:o.data)||(f==null?void 0:f.message)):console.warn("[AdminService] Failed to fetch weekly introductions stats for community ".concat(s," (status: ").concat(t,"):"),((p=f==null?void 0:f.response)==null?void 0:p.data)||(f==null?void 0:f.message)||f),null}}async getConversationsStarted(s,n,u){var d,o,p,f;try{let t="/communities/".concat(s,"/stats/conversations-started");const m=new URLSearchParams;n&&m.set("startDate",n),u&&m.set("endDate",u);const e=m.toString();e&&(t+="?".concat(e)),console.log("[AdminService] ðŸ’¬ Fetching conversations started: ".concat(t));const h=await T.get(t);return h&&typeof h=="object"?(console.log("[AdminService] âœ… Conversations started fetched:",{totalConversations:h.totalConversations,totalMessages:h.totalMessages,conversationsCount:((d=h.conversations)==null?void 0:d.length)||0}),h):null}catch(t){const m=(t==null?void 0:t.status)||((o=t==null?void 0:t.response)==null?void 0:o.status);return m===404?console.log("[AdminService] Conversations started endpoint not found for community ".concat(s," (404)")):m===500?console.warn("[AdminService] Conversations started endpoint returned 500 error for community ".concat(s,":"),((p=t==null?void 0:t.response)==null?void 0:p.data)||(t==null?void 0:t.message)):console.warn("[AdminService] Failed to fetch conversations started for community ".concat(s," (status: ").concat(m,"):"),((f=t==null?void 0:t.response)==null?void 0:f.data)||(t==null?void 0:t.message)||t),null}}async getWeeklyIntroductionsUsers(s,n,u){var d,o,p,f;try{if(!n||!u)return console.warn("[AdminService] startDate and endDate are required for weekly introductions users"),null;const t=new URLSearchParams;t.set("startDate",n),t.set("endDate",u);const m=t.toString(),e="/communities/".concat(s,"/stats/weekly-introductions/users?").concat(m);console.log("[AdminService] ðŸ“§ Fetching weekly introductions users: ".concat(e));const h=await T.get(e),a=Array.isArray(h)?h:h==null?void 0:h.rows;if(!Array.isArray(a))return console.warn("[AdminService] Weekly introductions users endpoint returned unexpected format or no rows for community ".concat(s)),[];const i=a.map(c=>{var S,A,$,U,_,M,y,C,b,w,I,k,P,F;const r=(A=(S=c.userId)!=null?S:c.user_id)!=null?A:c.id,l=(_=(U=($=c.fname)!=null?$:c.firstName)!=null?U:c.first_name)!=null?_:"",v=(C=(y=(M=c.lname)!=null?M:c.lastName)!=null?y:c.last_name)!=null?C:"",g=(w=(b=c.name)!=null?b:"".concat(l," ").concat(v).trim())!=null?w:"Unknown User";return{id:r,name:g,email:c.email,profilePicture:(I=c.profilePicture)!=null?I:c.profile_picture,introMessageSentAt:(F=(P=(k=c.introMessageSentAt)!=null?k:c.intro_message_sent_at)!=null?P:c.mostRecentIntroMessageSentAt)!=null?F:c.most_recent_intro_message_sent_at}}).filter(c=>typeof c.id=="number"&&!!c.name);return console.log("[AdminService] âœ… Fetched ".concat(i.length," weekly introductions users")),i}catch(t){const m=(t==null?void 0:t.status)||((d=t==null?void 0:t.response)==null?void 0:d.status);return m===400?console.warn("[AdminService] Weekly introductions users endpoint returned 400 (Bad Request) for community ".concat(s,":"),((p=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:p.error)||(t==null?void 0:t.message)):m===404?console.log("[AdminService] Weekly introductions users endpoint not found for community ".concat(s)):console.warn("[AdminService] Failed to fetch weekly introductions users for community ".concat(s," (status: ").concat(m,"):"),((f=t==null?void 0:t.response)==null?void 0:f.data)||(t==null?void 0:t.message)||t),null}}async getSelfIntroducedStats(s,n,u){var d,o,p,f,t;try{const m=new URLSearchParams;n&&m.set("startDate",n),u&&m.set("endDate",u);const e=m.toString(),h="/communities/".concat(s,"/stats/self-introduced").concat(e?"?".concat(e):"");console.log("[AdminService] ðŸ“¸ Fetching self-introduced stats: ".concat(h));const a=await T.get(h);console.log("[AdminService] ðŸ“¸ Self-introduced stats response:",a);let i=0;return typeof a=="number"?i=a:a&&typeof a=="object"&&(i=(f=(p=(o=(d=a.total)!=null?d:a.count)!=null?o:a.selfIntroduced)!=null?p:a.data)!=null?f:0),console.log("[AdminService] ðŸ“¸ Parsed self-introduced count: ".concat(i)),i!=null?{selfIntroduced:i}:(console.warn("[AdminService] Self-introduced stats endpoint returned invalid response for community ".concat(s)),null)}catch(m){const e=(m==null?void 0:m.status)||((t=m==null?void 0:m.response)==null?void 0:t.status);return e===404?console.log("[AdminService] Self-introduced stats endpoint not found for community ".concat(s," (404)")):e===500?console.warn("[AdminService] Self-introduced stats endpoint returned 500 for community ".concat(s)):console.warn("[AdminService] Failed to fetch self-introduced stats for community ".concat(s,":"),(m==null?void 0:m.message)||m),null}}async getSelfIntroducedUsers(s,n,u,d,o){var p,f,t,m,e,h;try{if(!n||!u)return console.warn("[AdminService] startDate and endDate are required for self-introduced users"),null;const a=new URLSearchParams;a.set("startDate",n),a.set("endDate",u),d!==void 0&&a.set("page",String(d)),o!==void 0&&a.set("limit",String(o));const i=a.toString(),c="/communities/".concat(s,"/stats/self-introduced/users?").concat(i);console.log("[AdminService] ðŸ“¸ Fetching self-introduced users: ".concat(c));const r=await T.get(c),l=Array.isArray(r)?r:(f=(p=r==null?void 0:r.rows)!=null?p:r==null?void 0:r.data)!=null?f:r==null?void 0:r.users;if(!Array.isArray(l))return console.warn("[AdminService] Self-introduced users endpoint returned unexpected format or no rows for community ".concat(s)),[];const v=l.map(g=>{var _,M,y,C,b,w,I,k,P,F,j,E,N,R,D,B;const S=(M=(_=g.userId)!=null?_:g.user_id)!=null?M:g.id,A=(b=(C=(y=g.fname)!=null?y:g.firstName)!=null?C:g.first_name)!=null?b:"",$=(k=(I=(w=g.lname)!=null?w:g.lastName)!=null?I:g.last_name)!=null?k:"",U=(F=(P=g.name)!=null?P:"".concat(A," ").concat($).trim())!=null?F:"Unknown User";return{id:S,name:U,email:g.email,profilePicture:(j=g.profilePicture)!=null?j:g.profile_picture,introducedAt:(R=(N=(E=g.introducedAt)!=null?E:g.introduced_at)!=null?N:g.createdAt)!=null?R:g.created_at,channelName:(D=g.channelName)!=null?D:g.channel_name,channelId:(B=g.channelId)!=null?B:g.channel_id}}).filter(g=>typeof g.id=="number"&&!!g.name);return console.log("[AdminService] âœ… Fetched ".concat(v.length," self-introduced users")),v}catch(a){const i=(a==null?void 0:a.status)||((t=a==null?void 0:a.response)==null?void 0:t.status);return i===400?console.warn("[AdminService] Self-introduced users endpoint returned 400 (Bad Request) for community ".concat(s,":"),((e=(m=a==null?void 0:a.response)==null?void 0:m.data)==null?void 0:e.error)||(a==null?void 0:a.message)):i===404?console.log("[AdminService] Self-introduced users endpoint not found for community ".concat(s)):console.warn("[AdminService] Failed to fetch self-introduced users for community ".concat(s," (status: ").concat(i,"):"),((h=a==null?void 0:a.response)==null?void 0:h.data)||(a==null?void 0:a.message)||a),null}}async getMentorMenteeStats(s){var u,d,o,p,f,t,m,e,h;const n=["/communities/".concat(s,"/stats/mentor-mentee"),"/communities/".concat(s,"/stats/mentors"),"/communities/".concat(s,"/mentor-mentee/stats"),"/console/stats/mentor-mentee?communityId=".concat(s),"/console/stats/mentors?communityId=".concat(s),"/console/communities/".concat(s,"/stats/mentor-mentee"),"/console/communities/".concat(s,"/stats/mentors"),"/stats/mentor-mentee?communityId=".concat(s),"/api/console/stats/mentor-mentee?communityId=".concat(s)];for(const a of n)try{console.log("[AdminService] ðŸŽ“ Trying mentor/mentee stats endpoint: ".concat(a));const i=await T.get(a);let c=0,r=0;if(i&&typeof i=="object"&&(c=(p=(o=(d=(u=i.usersCanMentor)!=null?u:i.canMentor)!=null?d:i.mentorCount)!=null?o:i.mentors)!=null?p:0,r=(e=(m=(t=(f=i.usersWantMentor)!=null?f:i.wantMentor)!=null?t:i.menteeCount)!=null?m:i.mentees)!=null?e:0,typeof c=="number"||typeof r=="number"))return console.log("[AdminService] âœ… Mentor/mentee stats fetched from: ".concat(a),{usersCanMentor:c,usersWantMentor:r}),{usersCanMentor:c,usersWantMentor:r}}catch(i){const c=(i==null?void 0:i.status)||((h=i==null?void 0:i.response)==null?void 0:h.status);c===404||console.warn("[AdminService] Error fetching mentor/mentee stats from ".concat(a,":"),{status:c,message:i==null?void 0:i.message})}return console.log("[AdminService] âš ï¸ All mentor/mentee stats endpoints failed, trying profile fallback"),this.getMentorMenteeStatsFallback(s)}async getMentorMenteeStatsFallback(s){try{const n=await this.getCachedProfiles(s),u=new Set,d=new Set;try{console.log("[AdminService] Trying to fetch unconsolidated skills data for mentor/mentee stats");const m=await this.getSkillsChartData(s,"all",!1,!0);if(m&&m.length>0){const e=m[0];if(console.log("[AdminService] Sample unconsolidated skill entry for stats:",e),m.forEach(h=>{const a=h.userId||h.user_id||h.id;if(a){const i=h.can_be_mentor||h.canBeMentor||h.canMentor,c=h.wants_to_be_mentee||h.wantsToBeMentee||h.wantMentor||h.wantsMentor;(i===!0||i===1||i==="true"||i==="1")&&u.add(a),(c===!0||c===1||c==="true"||c==="1")&&d.add(a)}}),u.size>0||d.size>0)return console.log("[AdminService] âœ… Found ".concat(u.size," mentors and ").concat(d.size," mentees from skills data")),{usersCanMentor:u.size,usersWantMentor:d.size}}}catch(m){console.log("[AdminService] Could not fetch unconsolidated skills data for stats:",m)}const o=["canMentor","can_mentor","dataCanMentor","data_can_mentor","is_active_mentor","isActiveMentor","isMentor","mentor","canMentorFlag","mentorFlag","isMentorActive"],p=["wantMentor","want_mentor","dataWantMentor","data_want_mentor","is_active_mentee","isActiveMentee","isMentee","mentee","wantsMentor","wantMentorFlag","menteeFlag","isMenteeActive","wants_mentor"];let f=0,t=0;return n.forEach(m=>{const e=m,h=m.userId||m.id,a=e.skills||e.dataSkills||e.userSkills;let i=!1,c=!1;if(a){let v=[];Array.isArray(a)?v=a:typeof a=="object"&&(v=Object.values(a));for(const g of v)if(typeof g=="object"&&g!==null){const S=g.can_be_mentor||g.canBeMentor||g.canMentor;(S===!0||S===1||S==="true"||S==="1")&&(i=!0);const A=g.wants_to_be_mentee||g.wantsToBeMentee||g.wantMentor||g.wantsMentor;(A===!0||A===1||A==="true"||A==="1")&&(c=!0)}}let r=i;if(!r)for(const v of o){let g=e[v];if(g==null&&(e.data&&typeof e.data=="object"&&(g=e.data[v]),g==null&&e.career&&typeof e.career=="object"&&(g=e.career[v]),g==null&&e.userCareer&&typeof e.userCareer=="object"&&(g=e.userCareer[v])),g!=null){if(typeof g=="boolean"&&g===!0){r=!0;break}else if(typeof g=="number"&&(g===1||g>0)){r=!0;break}else if(typeof g=="string"){const S=g.toLowerCase();if(S==="true"||S==="1"||S==="yes"){r=!0;break}}}}r&&f++;let l=c;if(!l)for(const v of p){let g=e[v];if(g==null&&(e.data&&typeof e.data=="object"&&(g=e.data[v]),g==null&&e.career&&typeof e.career=="object"&&(g=e.career[v]),g==null&&e.userCareer&&typeof e.userCareer=="object"&&(g=e.userCareer[v])),g!=null){if(typeof g=="boolean"&&g===!0){l=!0;break}else if(typeof g=="number"&&(g===1||g>0)){l=!0;break}else if(typeof g=="string"){const S=g.toLowerCase();if(S==="true"||S==="1"||S==="yes"){l=!0;break}}}}l&&t++}),console.log("[AdminService] âœ… Fallback: Calculated mentor/mentee stats from profiles:",{usersCanMentor:f,usersWantMentor:t}),{usersCanMentor:f,usersWantMentor:t}}catch(n){return console.error("[AdminService] Error in mentor/mentee stats fallback:",n),null}}async getMentorMenteeUsers(s,n){var d;const u=["/communities/".concat(s,"/mentors/").concat(n==="can"?"mentors":"mentees"),"/communities/".concat(s,"/mentor-mentee/").concat(n==="can"?"mentors":"mentees"),"/communities/".concat(s,"/users/mentor-mentee?type=").concat(n),"/console/communities/".concat(s,"/mentors/").concat(n==="can"?"mentors":"mentees")];for(const o of u)try{console.log("[AdminService] ðŸŽ“ Trying mentor/mentee users endpoint: ".concat(o));const p=await T.get(o);if(p&&Array.isArray(p))return console.log("[AdminService] âœ… Found ".concat(p.length," ").concat(n==="can"?"mentors":"mentees")),p}catch(p){const f=(p==null?void 0:p.status)||((d=p==null?void 0:p.response)==null?void 0:d.status);f===404||console.warn("[AdminService] Error fetching mentor/mentee users from ".concat(o,":"),{status:f,message:p==null?void 0:p.message})}return console.log("[AdminService] âš ï¸ All mentor/mentee endpoints failed, trying profile fallback for ".concat(n==="can"?"mentors":"mentees")),this.getMentorMenteeUsersFallback(s,n)}async getMentorMenteeUsersFallback(s,n){try{const u=await this.getCachedProfiles(s);let d=new Map;try{console.log("[AdminService] Trying to fetch unconsolidated skills data for mentor/mentee flags");const t=await this.getSkillsChartData(s,"all",!1,!0);if(t&&t.length>0){const m=t[0];console.log("[AdminService] Sample unconsolidated skill entry:",m),t.forEach(e=>{const h=e.userId||e.user_id||e.id;if(h){const a=e.can_be_mentor||e.canBeMentor||e.canMentor,i=e.wants_to_be_mentee||e.wantsToBeMentee||e.wantMentor||e.wantsMentor;if(a!==void 0||i!==void 0){const c=d.get(h)||{canMentor:!1,wantMentor:!1};(a===!0||a===1||a==="true"||a==="1")&&(c.canMentor=!0),(i===!0||i===1||i==="true"||i==="1")&&(c.wantMentor=!0),d.set(h,c)}}}),d.size>0&&console.log("[AdminService] âœ… Found ".concat(d.size," users with mentor/mentee flags from skills data"))}}catch(t){console.log("[AdminService] Could not fetch unconsolidated skills data:",t)}const o=n==="can"?"canMentor":"wantMentor",p=n==="can"?["canMentor","can_mentor","dataCanMentor","data_can_mentor","is_active_mentor","isActiveMentor","isMentor","mentor","canMentorFlag","mentorFlag","isMentorActive"]:["wantMentor","want_mentor","dataWantMentor","data_want_mentor","is_active_mentee","isActiveMentee","isMentee","mentee","wantsMentor","wantMentorFlag","menteeFlag","isMenteeActive","wants_mentor"];if(console.log("[AdminService] Fallback: Filtering ".concat(u.length," profiles for ").concat(o)),u.length>0){const t=u[0];console.log("[AdminService] ðŸ” Sample profile structure for mentor/mentee detection:",{userId:t.userId||t.id,hasSkills:!!t.skills,hasDataSkills:!!t.dataSkills,hasUserSkills:!!t.userSkills,skillsType:typeof t.skills,dataSkillsType:typeof t.dataSkills,skillsValue:t.skills,dataSkillsValue:t.dataSkills,allKeys:Object.keys(t),hasData:!!t.data,hasCareer:!!t.career,hasUserCareer:!!t.userCareer}),Array.isArray(t.dataSkills)&&t.dataSkills.length>0&&console.log("[AdminService] ðŸ” Sample dataSkills entry:",t.dataSkills[0],"(type: ".concat(typeof t.dataSkills[0],")"))}const f=u.map(t=>{const m=t,e=t.userId||t.id,h=[],a=m.skills||m.dataSkills||m.userSkills;if(a){let i=[];Array.isArray(a)?i=a:typeof a=="object"&&(i=Object.values(a));for(const c of i)if(typeof c=="object"&&c!==null){const r=c.name||c.skill||c.value||"";if(n==="can"){const l=c.can_be_mentor||c.canBeMentor||c.canMentor;(l===!0||l===1||l==="true"||l==="1")&&r&&h.push(r)}if(n==="want"){const l=c.wants_to_be_mentee||c.wantsToBeMentee||c.wantMentor||c.wantsMentor;(l===!0||l===1||l==="true"||l==="1")&&r&&h.push(r)}}else typeof c=="string"&&c.trim()}return{id:e,fname:t.fname,lname:t.lname,fullName:t.fullName||"".concat(t.fname," ").concat(t.lname),email:"",profilePicture:t.profilePicture,isManager:!1,enabled:!0,joinDate:void 0,jobTitle:t.jobTitle,currentEmployer:t.currentEmployer,mentorSkills:n==="can"?h:void 0,menteeSkills:n==="want"?h:void 0,_profile:t,_relevantSkills:h}}).filter(t=>{const m=t._profile;if(!m)return!1;if(t._relevantSkills||(t._relevantSkills=[]),t._relevantSkills.length>0)return console.log("[AdminService] Found ".concat(t._relevantSkills.length," skill(s) with ").concat(n==="can"?"can_be_mentor":"wants_to_be_mentee","=true for user ").concat(t.id,":"),t._relevantSkills),!0;const e=m,h=d.get(t.id);if(h){if(n==="can"&&h.canMentor)return console.log("[AdminService] Found can_be_mentor=true from skills data for user ".concat(t.id)),!0;if(n==="want"&&h.wantMentor)return console.log("[AdminService] Found wants_to_be_mentee=true from skills data for user ".concat(t.id)),!0}const a=e.skills||e.dataSkills||e.userSkills;if(a){let c=[];Array.isArray(a)?c=a:typeof a=="object"&&(c=Object.values(a));for(const r of c)if(typeof r=="object"&&r!==null){const l=r.name||r.skill||r.value||"";if(n==="can"){const v=r.can_be_mentor||r.canBeMentor||r.canMentor;(v===!0||v===1||v==="true"||v==="1")&&(l&&!t._relevantSkills.includes(l)&&t._relevantSkills.push(l),console.log("[AdminService] Found can_be_mentor=true in skills for user ".concat(t.id).concat(l?" (skill: ".concat(l,")"):"")))}if(n==="want"){const v=r.wants_to_be_mentee||r.wantsToBeMentee||r.wantMentor||r.wantsMentor;(v===!0||v===1||v==="true"||v==="1")&&(l&&!t._relevantSkills.includes(l)&&t._relevantSkills.push(l),console.log("[AdminService] Found wants_to_be_mentee=true in skills for user ".concat(t.id).concat(l?" (skill: ".concat(l,")"):"")))}}if(t._relevantSkills.length>0)return!0}let i=!1;for(const c of p){let r=e[c];if(r==null&&(e.data&&typeof e.data=="object"&&(r=e.data[c]),r==null&&e.career&&typeof e.career=="object"&&(r=e.career[c]),r==null&&e.userCareer&&typeof e.userCareer=="object"&&(r=e.userCareer[c])),r!=null){let l=!1;if(typeof r=="boolean")l=r===!0;else if(typeof r=="number")l=r===1||r>0;else if(typeof r=="string"){const v=r.toLowerCase();l=v==="true"||v==="1"||v==="yes"}if(l){if(i=!0,t._relevantSkills.length===0){const v=e.skills||e.dataSkills||e.userSkills;if(v){let g=[];Array.isArray(v)?g=v:typeof v=="object"&&(g=Object.values(v)),g.forEach(S=>{if(typeof S=="object"&&S!==null){const A=S.name||S.skill||S.value||"";A&&!t._relevantSkills.includes(A)&&t._relevantSkills.push(A)}else typeof S=="string"&&S.trim()&&(t._relevantSkills.includes(S)||t._relevantSkills.push(S))})}}break}}}return!!i}).map(t=>{const{_profile:m,_relevantSkills:e=[],...h}=t;return n==="can"?h.mentorSkills=e:h.menteeSkills=e,h});return console.log("[AdminService] âœ… Fallback: Found ".concat(f.length," ").concat(n==="can"?"mentors":"mentees"," from profiles")),f}catch(u){return console.error("[AdminService] Error in mentor/mentee fallback:",u),[]}}async calculateSkillsStats(s){try{console.log("[AdminService] ðŸŽ“ Calculating skills stats for community ".concat(s));const n={totalSkills:0,usersWithSkills:0};try{const u=await this.getSkillsChartData(s,"all",!0,!0),d=new Set,o=new Set;u.forEach(p=>{d.add(p.name),p.value&&p.value>0}),n.totalSkills=d.size;try{const p=await this.getCachedProfiles(s);console.log("[AdminService] ðŸŽ“ Processing ".concat(p.length," profiles for skills calculation")),p.forEach(f=>{const t=f.userId||f.id||f.user_id;if(!t)return;const m=f.skills||f.dataSkills||f.userSkills;m&&(Array.isArray(m)&&m.length>0||typeof m=="object"&&Object.keys(m).length>0||typeof m=="string"&&m.trim().length>0)&&o.add(t)}),n.usersWithSkills=o.size,console.log("[AdminService] ðŸŽ“ Skills stats from profiles:",{usersWithSkills:n.usersWithSkills})}catch(p){console.warn("[AdminService] Could not get profile data for skills calculation:",p);const f=u.filter(t=>t.value&&t.value>0);f.length>0&&(n.usersWithSkills=Math.max(d.size,f.length))}console.log("[AdminService] ðŸŽ“ Skills stats calculated:",n)}catch(u){console.warn("[AdminService] Could not calculate skills stats:",u)}return n}catch(n){return console.error("[AdminService] Error calculating skills stats:",n),{totalSkills:0,usersWithSkills:0}}}async getMatchEngagementStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/match-engagement");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?this.calculateMatchEngagementStats(s,n,u):(console.warn("[AdminService] Error fetching match engagement stats:",o),null)}}async calculateMatchEngagementStats(s,n,u){try{const d={trovaMagicMatches:0,trovaMagicSessions:0,channelPairingMatches:0,channelPairingSessions:0,mentorMenteeMatches:0,allMatchesEngaged:0,matchEngagementRate:0};let o=0,p=0,f=0;try{const r=await this.getMagicIntrosByDate(s,n,u),l=r.filter(g=>g.totalPairings<=1e3);o=l.reduce((g,S)=>g+S.totalPairings,0),p=l.reduce((g,S)=>g+S.engagedPairings,0);const v=await this.getMatchesForCommunity(s,n,u,"trova_magic");f=(v==null?void 0:v.length)||0,console.log("[AdminService] ðŸ”— Trova Magic: ".concat(f," sessions â†’ ").concat(o," unique pairs, ").concat(p," engaged (").concat(l.length," valid dates, ").concat(r.length-l.length," dates excluded)"))}catch(r){console.warn("[AdminService] Could not fetch Trova Magic from daily breakdown:",r)}d.trovaMagicMatches=o,d.trovaMagicSessions=f,d.trovaMagicEngagements=p;const t=await this.getMatchesForCommunity(s,n,u,"channel_pairing"),m=new Set,e=new Map;if(t&&t.length>0)for(const r of t){const l=r.groupId||r.group_id||(r.matchIndicesId&&r.matchIndicesId!==0?r.matchIndicesId:null);l!=null&&(m.has(l)||(m.add(l),e.set(l,r)))}d.channelPairingMatches=m.size,d.channelPairingSessions=(t==null?void 0:t.length)||0;let h=0;if(m.size>0)try{h=await this.countEngagedMatchesByGroup(s,t,m)}catch(r){console.warn("[AdminService] Could not calculate channel pairing engagement:",r)}d.channelPairingEngagements=h;let a=0,i=0;try{console.log("[AdminService] ðŸŽ“ Fetching mentor/mentee matches for stats calculation",{startDate:n,endDate:u});const r=await this.getMentorMenteeUsersWithMatches(s,n,u);a=r.reduce((v,g)=>v+g.matchCount,0);const l=await this.getMatchesForCommunity(s,n,u,"mentor-mentee");if(l&&l.length>0){const v=new Set;for(const g of l){const S=g.userId||g.user_id,A=g.matchedUserId||g.matched_user_id;if(S&&A){const $=[S,A].sort((U,_)=>U-_).join("-");v.add($)}}i=v.size}console.log("[AdminService] ðŸŽ“ Mentor/Mentee: ".concat(a," sessions, ").concat(i," unique pairs (from ").concat(r.length," users)"))}catch(r){console.error("[AdminService] Error fetching Mentor/Mentee matches:",r)}d.mentorMenteeMatches=a,d.mentorMenteeUniquePairs=i,d.mentorMenteeEngagements=0;const c=d.trovaMagicMatches+d.channelPairingMatches+d.mentorMenteeMatches;return c>0&&(d.allMatchesEngaged=p+h,d.matchEngagementRate=d.allMatchesEngaged/c*100),console.log("[AdminService] ðŸ”— Match engagement: ".concat(d.trovaMagicMatches," Trova Magic (").concat(d.trovaMagicEngagements," engaged), ").concat(d.channelPairingMatches," Channel Pairing (").concat(h," engaged), ").concat(d.mentorMenteeMatches," Mentor/Mentee (matches only, no engagement tracking), ").concat(d.allMatchesEngaged,"/").concat(c," total engaged")),d}catch(d){return console.warn("[AdminService] Error calculating match engagement stats:",d),null}}async getChannelPairingStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/channel-pairing");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?this.calculateChannelPairingStats(s,n,u):(console.warn("[AdminService] Error fetching channel pairing stats:",o),null)}}async calculateChannelPairingStats(s,n,u){try{const d={channelPairingGroups:0,channelPairingUsers:0,channelPairingOnDemand:0,channelPairingCadence:0},o=await this.getMatchesForCommunity(s,n,u,"channel_pairing");if(o&&o.length>0){const p=new Set,f=new Set;o.forEach(e=>{const h=e.groupId||e.group_id;h&&p.add(h),e.userId&&f.add(e.userId),e.matchedUserId&&f.add(e.matchedUserId)}),d.channelPairingGroups=p.size,d.channelPairingUsers=f.size;let t=0,m=0;o.forEach(e=>{const h=e.isOnDemand||e.onDemand||e.triggerType==="on_demand"||e.triggerType==="manual",a=e.isCadence||e.cadence||e.triggerType==="cadence"||e.triggerType==="scheduled"||e.scheduled;h?t++:a?m++:e.triggeredAt||e.manualTrigger?t++:(e.scheduledAt||e.nextRun,m++)}),d.channelPairingOnDemand=t,d.channelPairingCadence=m}return d}catch(d){return console.warn("[AdminService] Error calculating channel pairing stats:",d),null}}async getMessageStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/messages");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?this.calculateMessageStats(s,n,u):(console.error("Failed to fetch message stats:",o),null)}}async getConversationsForCommunity(s){const n=this.getConversationsCacheKey(s),u=this.conversationsCache.get(n);if(u&&this.isCacheValid(u.timestamp,this.FIREBASE_CACHE_TTL))return console.log("[AdminService] âœ… Using cached conversations for community ".concat(s)),u.data;const o=K().firestore;if(!o)return new Set;const p=H(o,"messages"),f=O(p,x("communityId","==",s)),t=await Q(f),m=new Set;return t.forEach(e=>{m.add(e.id)}),this.conversationsCache.set(n,{data:m,timestamp:Date.now()}),m}async calculateMessageStats(s,n,u){try{const o=K().firestore;if(!o)return console.warn("[AdminService] Firestore not initialized, cannot query messages"),{totalMessagesSent:0};console.log("[AdminService] ðŸ“¨ Starting message stats calculation for community ".concat(s));const p=await this.getConversationsForCommunity(s);if(p.size===0)return console.log("[AdminService] ðŸ“¨ No conversations found for community ".concat(s)),{totalMessagesSent:0};const f=n?Z.fromDate(new Date(n)):null,t=u?Z.fromDate(new Date(u)):null;let m=0;const e=10,h=Array.from(p);console.log("[AdminService] ðŸ“¨ Querying messages from ".concat(h.length," conversations (all types: MPIM, breakout groups, directory, magic intros) in batches of ").concat(e));for(let a=0;a<h.length;a+=e){const c=h.slice(a,a+e).map(async l=>{try{const v=H(o,"messages/".concat(l,"/conv")),g=f&&t?O(v,x("timestamp",">=",f),x("timestamp","<=",t)):O(v);return(await Q(g)).size}catch(v){return console.debug("[AdminService] Could not query messages subcollection for ".concat(l,":"),v),0}}),r=await Promise.all(c);m+=r.reduce((l,v)=>l+v,0),h.length>50&&(a+e)%50===0&&console.log("[AdminService] ðŸ“¨ Processed ".concat(Math.min(a+e,h.length),"/").concat(h.length," conversations"))}return console.log("[AdminService] ðŸ“¨ Calculated ".concat(m," total messages sent for community ").concat(s," (includes all conversation types)")),{totalMessagesSent:m}}catch(d){return console.error("[AdminService] Error calculating message stats:",d),{totalMessagesSent:0}}}async getMessagesFromMatches(s,n,u){try{const o=K().firestore;if(!o)return console.warn("[AdminService] Firestore not initialized, cannot query messages"),{totalMessagesSent:0};console.log("[AdminService] ðŸ“¨ Getting messages from match-based conversations for community ".concat(s));const p=await this.getMatchesForCommunity(s,n,u);if(!p||p.length===0)return console.log("[AdminService] ðŸ“¨ No matches found, returning 0 messages"),{totalMessagesSent:0};const f=new Set;p.forEach(l=>{const v=l.userId||l.user_id,g=l.matchedUserId||l.matched_user_id;if(v&&g){const S=[v,g].sort((A,$)=>A-$).join("-");f.add(S)}}),console.log("[AdminService] ðŸ“¨ Found ".concat(f.size," unique user pairs from ").concat(p.length," matches"));const t=await this.getConversationsForCommunity(s);if(t.size===0)return console.log("[AdminService] ðŸ“¨ No conversations found"),{totalMessagesSent:0};const m=new Set,e=10,h=Array.from(t);for(let l=0;l<h.length;l+=e){const g=h.slice(l,l+e).map(async A=>{try{const $=await J(V(o,"messages/".concat(A)));if($.exists()){const U=$.data();if(U.users&&Array.isArray(U.users)){const _=U.users.filter(M=>typeof M=="number");for(let M=0;M<_.length;M++)for(let y=M+1;y<_.length;y++){const C=[_[M],_[y]].sort((b,w)=>b-w).join("-");if(f.has(C))return A}}}return null}catch($){return console.debug("[AdminService] Error checking conversation ".concat(A,":"),$),null}});(await Promise.all(g)).forEach(A=>{A&&m.add(A)})}console.log("[AdminService] ðŸ“¨ Found ".concat(m.size," conversations from ").concat(t.size," total that match user pairs from matches"));const a=n?Z.fromDate(new Date(n)):null,i=u?Z.fromDate(new Date(u)):null;let c=0;const r=Array.from(m);for(let l=0;l<r.length;l+=e){const g=r.slice(l,l+e).map(async A=>{try{const $=H(o,"messages/".concat(A,"/conv")),U=a&&i?O($,x("timestamp",">=",a),x("timestamp","<=",i)):O($);return(await Q(U)).size}catch($){return console.debug("[AdminService] Could not query messages subcollection for ".concat(A,":"),$),0}}),S=await Promise.all(g);c+=S.reduce((A,$)=>A+$,0)}return console.log("[AdminService] ðŸ“¨ Calculated ".concat(c," unique messages from match-based conversations (from ").concat(m.size," conversations)")),{totalMessagesSent:c}}catch(d){return console.error("[AdminService] Error getting messages from matches:",d),{totalMessagesSent:0}}}async getEventStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/events");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?(console.log("[AdminService] Event stats endpoint not found for community ".concat(s)),null):(console.error("Failed to fetch event stats:",o),null)}}async getGroupStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/groups");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?(console.log("[AdminService] Group stats endpoint not found for community ".concat(s)),null):(console.error("Failed to fetch group stats:",o),null)}}async getActiveUserStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/active-users");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?this.calculateActiveUserStats(s,n,u):(console.error("Failed to fetch active user stats:",o),null)}}async calculateActiveUserStats(s,n,u){try{console.log("[AdminService] ðŸ‘¥ Starting active user stats calculation for community ".concat(s));const d=new Set,o=new Set,p=u?new Date(u):new Date,f=new Date(p);f.setUTCDate(f.getUTCDate()-1),f.setUTCHours(0,0,0,0);const t=new Date(p);t.setUTCDate(t.getUTCDate()-7),t.setUTCHours(0,0,0,0),console.log("[AdminService] ðŸ‘¥ Date ranges: daily (>= ".concat(f.toISOString(),"), weekly (>= ").concat(t.toISOString(),")"));try{const e=await this.getMatchesForCommunity(s);console.log("[AdminService] ðŸ‘¥ Found ".concat(e.length," matches for active user calculation")),e.forEach(h=>{const a=h.createdAt||h.created_at;if(a){const i=new Date(a);i>=f&&(h.userId&&d.add(h.userId),h.matchedUserId&&d.add(h.matchedUserId)),i>=t&&(h.userId&&o.add(h.userId),h.matchedUserId&&o.add(h.matchedUserId))}}),console.log("[AdminService] ðŸ‘¥ After matches: ".concat(d.size," daily, ").concat(o.size," weekly"))}catch(e){console.warn("[AdminService] Could not get matches for active users:",e)}try{const e=await this.getEventsForCommunity(s);console.log("[AdminService] ðŸ‘¥ Found ".concat(e.length," events for active user calculation")),e.forEach(h=>{if(h.userId||h.createdBy){const a=h.userId||h.createdBy,i=h.startDate||h.startDateTimeUTC;if(i){const c=new Date(i);c>=f&&d.add(a),c>=t&&o.add(a)}}h.attendees&&Array.isArray(h.attendees)&&h.attendees.forEach(a=>{const i=a.id||a.userId||a;if(typeof i=="number"){const c=h.startDate||h.startDateTimeUTC;if(c){const r=new Date(c);r>=f&&d.add(i),r>=t&&o.add(i)}}})}),console.log("[AdminService] ðŸ‘¥ After events: ".concat(d.size," daily, ").concat(o.size," weekly"))}catch(e){console.warn("[AdminService] Could not get events for active users:",e)}try{const e=await this.getGroupsForCommunity(s);console.log("[AdminService] ðŸ‘¥ Found ".concat(e.length," groups for active user calculation")),e.forEach(h=>{h.users&&Array.isArray(h.users)&&h.users.forEach(a=>{const i=a.id||a.userId||a;if(typeof i=="number"){const c=h.updatedAt||h.createdAt;if(c){const r=new Date(c);r>=f&&d.add(i),r>=t&&o.add(i)}}})}),console.log("[AdminService] ðŸ‘¥ After groups: ".concat(d.size," daily, ").concat(o.size," weekly"))}catch(e){console.warn("[AdminService] Could not get groups for active users:",e)}try{const h=K().firestore;if(h){const a=await this.getConversationsForCommunity(s);console.log("[AdminService] ðŸ‘¥ Found ".concat(a.size," conversations for active user calculation"));const i=10,c=Array.from(a);for(let r=0;r<c.length;r+=i){const v=c.slice(r,r+i).map(async g=>{try{const S=await J(V(h,"messages/".concat(g)));if(S.exists()){const A=S.data();if(A.users&&Array.isArray(A.users)){const $=A.updatedAt||A.timestamp;if($){const U=$.toMillis?new Date($.toMillis()):new Date($.seconds*1e3),_=U>=f,M=U>=t;A.users.forEach(y=>{_&&d.add(y),M&&o.add(y)})}}}}catch(S){console.debug("[AdminService] Error fetching conversation ".concat(g,":"),S)}});await Promise.all(v)}}console.log("[AdminService] ðŸ‘¥ After messages: ".concat(d.size," daily, ").concat(o.size," weekly"))}catch(e){console.warn("[AdminService] Could not get messages for active users:",e)}const m={dailyActiveUsers:d.size,weeklyActiveUsers:o.size};return console.log("[AdminService] ðŸ‘¥ Final active users: ".concat(d.size," daily, ").concat(o.size," weekly")),m}catch(d){return console.error("[AdminService] Error calculating active user stats:",d),{dailyActiveUsers:0,weeklyActiveUsers:0}}}async getProfileCompletionStats(s){var n;try{return await T.get("/communities/".concat(s,"/stats/profile-completion"))}catch(u){return(u==null?void 0:u.status)===404||((n=u==null?void 0:u.response)==null?void 0:n.status)===404?(console.log("[AdminService] Profile completion stats endpoint not found for community ".concat(s)),null):(console.error("Failed to fetch profile completion stats:",u),null)}}async getMatchResponseStats(s,n,u){var d;try{let o="/communities/".concat(s,"/stats/match-response");return n&&u&&(o+="?startDate=".concat(n,"&endDate=").concat(u)),await T.get(o)}catch(o){return(o==null?void 0:o.status)===404||((d=o==null?void 0:o.response)==null?void 0:d.status)===404?(console.log("[AdminService] Match response stats endpoint not found for community ".concat(s)),null):(console.error("Failed to fetch match response stats:",o),null)}}async calculateMatchResponseRate(s,n,u,d){try{if(!n||n.length===0)return 0;const o=await this.getConversationPairs(s);let p=0;n.forEach(t=>{const m=t.userId,e=t.matchedUserId;if(m&&e){const h=[m,e].sort((a,i)=>a-i).join("-");o.has(h)&&p++}});const f=n.length>0?p/n.length*100:0;return console.log("[AdminService] Match response rate: ".concat(f.toFixed(1),"% (").concat(p,"/").concat(n.length," matches led to conversations)")),f}catch(o){return console.error("[AdminService] Error calculating match response rate:",o),0}}async getConversationPairs(s){const n="conversationPairs_".concat(s),u=this.conversationsCache.get(n);if(u&&this.isCacheValid(u.timestamp,this.FIREBASE_CACHE_TTL))return console.log("[AdminService] âœ… Using cached conversation pairs for community ".concat(s)),u.data;const o=K().firestore;if(!o)return new Set;const p=await this.getConversationsForCommunity(s);if(p.size===0)return new Set;const f=new Set,t=10,m=Array.from(p);for(let e=0;e<m.length;e+=t){const a=m.slice(e,e+t).map(async i=>{try{const c=await J(V(o,"messages/".concat(i)));if(c.exists()){const r=c.data();if(r.users&&Array.isArray(r.users)&&r.users.length>=2){const l=r.users.filter(v=>typeof v=="number");for(let v=0;v<l.length;v++)for(let g=v+1;g<l.length;g++){const S=[l[v],l[g]].sort((A,$)=>A-$).join("-");f.add(S)}}}}catch(c){console.debug("[AdminService] Error fetching conversation ".concat(i,":"),c)}});await Promise.all(a)}return this.conversationsCache.set(n,{data:f,timestamp:Date.now()}),f}async countEngagedMatches(s,n){try{if(!n||n.length===0)return 0;const u=await this.getConversationPairs(s);let d=0;return n.forEach(o=>{const p=o.userId,f=o.matchedUserId;if(p&&f){const t=[p,f].sort((m,e)=>m-e).join("-");u.has(t)&&d++}}),d}catch(u){return console.warn("[AdminService] Error counting engaged matches:",u),0}}async countEngagedMatchesByGroup(s,n,u){try{if(!n||n.length===0||u.size===0)return 0;const d=await this.getConversationPairs(s),o=new Map;n.forEach(f=>{const t=f.groupId||f.group_id||(f.matchIndicesId&&f.matchIndicesId!==0?f.matchIndicesId:null);if(t&&u.has(t)){const m=f.userId||f.user_id,e=f.matchedUserId||f.matched_user_id;if(m&&e){o.has(t)||o.set(t,new Set);const h=[m,e].sort((a,i)=>a-i).join("-");o.get(t).add(h)}}});let p=0;return o.forEach((f,t)=>{Array.from(f).some(e=>d.has(e))&&p++}),p}catch(d){return console.warn("[AdminService] Error counting engaged matches by group:",d),0}}async getTrovaChatsCount(s,n,u){try{const o=K().firestore;if(!o)return console.warn("[AdminService] Firestore not initialized, cannot query Trova chats"),0;console.log("[AdminService] ðŸ’¬ Starting Trova chats calculation for community ".concat(s));const p=n?Z.fromDate(new Date(n)):null,f=u?Z.fromDate(new Date(u)):null,t=await this.getConversationsForCommunity(s);if(t.size===0)return console.log("[AdminService] ðŸ’¬ No conversations found for community ".concat(s)),0;const m=new Set,e=Array.from(t),h=10;console.log("[AdminService] ðŸ’¬ Checking ".concat(e.length," conversations for Trova messages in batches of ").concat(h));for(let a=0;a<e.length;a+=h){const i=e.slice(a,a+h),c=i.map(async l=>{try{const v=await J(V(o,"messages/".concat(l)));if(!v.exists())return!1;const g=v.data(),S=(g.lastMessage||"").toLowerCase(),A=(g.messageTitle||"").toLowerCase();if(S.includes("trova")||A.includes("trova"))if(p||f){const $=g.createdAt;if($){const U=$.toMillis?$.toMillis():$.seconds*1e3,_=p?p.toMillis():0,M=f?f.toMillis():Date.now();if(U>=_&&U<=M)return!0}}else return!0;try{const $=H(o,"messages/".concat(l,"/conv")),U=p&&f?O($,x("timestamp",">=",p),x("timestamp","<=",f)):O($),_=await Q(U);for(const M of _.docs){const y=M.data();if((y.message||"").toLowerCase().includes("trova")){if(p&&f)return!0;const b=y.timestamp||y.createdAt;if(b){const w=b.toMillis?b.toMillis():b.seconds*1e3,I=p?p.toMillis():0,k=f?f.toMillis():Date.now();if(w>=I&&w<=k)return!0}else return!0}}}catch($){console.debug("[AdminService] Could not query subcollection for ".concat(l,":"),$)}return!1}catch(v){return console.debug("[AdminService] Error checking conversation ".concat(l,":"),v),!1}});(await Promise.all(c)).forEach((l,v)=>{l&&m.add(i[v])}),e.length>50&&(a+h)%50===0&&console.log("[AdminService] ðŸ’¬ Processed ".concat(Math.min(a+h,e.length),"/").concat(e.length," conversations"))}return console.log("[AdminService] ðŸ’¬ Found ".concat(m.size," Trova-initiated chats for community ").concat(s)),m.size}catch(d){return console.error("[AdminService] Error querying Trova chats from Firebase:",d),0}}async getTrovaChats(s,n,u){try{return{trovaChatsStarted:await this.getTrovaChatsCount(s,n,u)}}catch(d){return console.error("Failed to fetch Trova chats:",d),null}}async exportData(s,n,u,d){var o;try{let p="/communities/".concat(s,"/export/").concat(n);u&&d&&(p+="?startDate=".concat(u,"&endDate=").concat(d));const f=(await L(()=>import("./index-CkJ7yJ3n.js").then(i=>i.bV),__vite__mapDeps([1,2]))).default,{environment:t}=await L(()=>import("./index-CkJ7yJ3n.js").then(i=>i.bT),__vite__mapDeps([1,2])),{useFirebase:m}=await L(()=>import("./index-CkJ7yJ3n.js").then(i=>i.bU),__vite__mapDeps([1,2])),e=m();let h={};if((o=e.auth)!=null&&o.currentUser){const i=await e.auth.currentUser.getIdToken();h.Authorization="Bearer ".concat(i)}return(await f.get("".concat(t.apiUrl).concat(p),{headers:h,responseType:"blob",withCredentials:!0})).data}catch(p){throw console.error("Failed to export data:",p),p}}downloadCSV(s,n){const u=window.URL.createObjectURL(s),d=document.createElement("a");d.href=u,d.download=n,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(u)}async getMagicIntrosByDate(s,n,u){try{console.log("[AdminService] âœ¨ Fetching magic intros by date for community ".concat(s));const d=await this.getMatchesForCommunity(s,n,u,"trova_magic");if(!d||d.length===0)return[];const o=n?new Date(n):null,p=u?new Date(u):null,f=new Map;let t=0,m=0;d.forEach(i=>{const c=i.createdAt||i.created_at;if(!c){t++;return}let r;if(typeof c=="string"?r=new Date(c):c.toDate?r=c.toDate():c.seconds?r=new Date(c.seconds*1e3):r=new Date(c),isNaN(r.getTime())){t++,console.warn("[AdminService] Invalid date for match ".concat(i.id,":"),c);return}if(o&&r<o){m++;return}if(p&&r>p){m++;return}const l=r.toISOString().split("T")[0];if(!/^\d{4}-\d{2}-\d{2}$/.test(l)){t++,console.warn("[AdminService] Invalid date string format for match ".concat(i.id,":"),l);return}f.has(l)||f.set(l,[]),f.get(l).push(i)}),(t>0||m>0)&&console.log("[AdminService] âœ¨ Filtered ".concat(d.length," matches: ").concat(t," invalid dates, ").concat(m," out of range"));const e=await this.getConversationPairs(s),h=[];for(const[i,c]of f.entries()){const l=new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),v=new Set,g=new Map;for(const $ of c){const U=$.userId||$.user_id,_=$.matchedUserId||$.matched_user_id;if(!U||!_)continue;const M=[U,_].sort((y,C)=>y-C).join("-");if(!v.has(M)){v.add(M);const y=e.has(M);g.set(M,y)}}const S=Array.from(g.values()).filter($=>$).length,A=v.size>0?S/v.size*100:0;console.log("[AdminService] Date ".concat(i,": ").concat(v.size," unique pairs, ").concat(S," engaged (from ").concat(c.length," matches)")),h.push({date:i,dateDisplay:l,totalPairings:v.size,engagedPairings:S,engagementRate:Math.round(A*10)/10})}h.sort((i,c)=>c.date.localeCompare(i.date));const a=h.filter(i=>i.totalPairings>1e3);return a.length>0&&console.warn("[AdminService] âš ï¸ Found ".concat(a.length," dates with >1000 pairings (possible data issue):"),a.map(i=>"".concat(i.date,": ").concat(i.totalPairings))),console.log("[AdminService] âœ¨ Found ".concat(h.length," magic intro dates, total pairings: ").concat(h.reduce((i,c)=>i+c.totalPairings,0))),h}catch(d){return console.error("[AdminService] Error fetching magic intros by date:",d),[]}}async getMagicIntroPairings(s,n,u,d){try{console.log("[AdminService] âœ¨ Fetching pairings for magic intro date ".concat(n));const o=await this.getMatchesForCommunity(s,u,d,"trova_magic");if(!o||o.length===0)return[];const p=o.filter(c=>{const r=c.createdAt||c.created_at;if(!r)return!1;let l;typeof r=="string"?l=new Date(r):r.toDate?l=r.toDate():r.seconds?l=new Date(r.seconds*1e3):l=new Date(r);const v=l.toISOString().split("T")[0],g=n.includes("T")?n.split("T")[0]:n;return v===g}),f=await this.getConversationPairs(s),t=new Map;console.log("[AdminService] Processing ".concat(p.length," matches for date ").concat(n));for(const c of p){const r=c.userId||c.user_id,l=c.matchedUserId||c.matched_user_id;if(!r||!l){console.log("[AdminService] Skipping match ".concat(c.id," - missing userId or matchedUserId"));continue}const v=[r,l].sort((g,S)=>g-S).join("-");if(t.has(v))console.log("[AdminService] Skipping duplicate pair ".concat(v," (users ").concat(r," and ").concat(l,")"));else{const g=c.groupId||c.group_id||(c.matchIndicesId&&c.matchIndicesId!==0?c.matchIndicesId:null),S=f.has(v);t.set(v,{...c,id:"pair-".concat(v),groupId:g,userId:r,matchedUserId:l,isEngaged:S})}}const m=Array.from(t.values());console.log("[AdminService] Deduplicated to ".concat(m.length," unique pairings from ").concat(p.length," matches"));const e=new Set;m.forEach(c=>{c.userId&&e.add(c.userId),c.matchedUserId&&e.add(c.matchedUserId)});const{userService:h}=await L(()=>import("./index-CkJ7yJ3n.js").then(c=>c.bZ),__vite__mapDeps([1,2])),a=await h.getUsersByIds(Array.from(e)),i=m.map(c=>{const r=a.get(c.userId),l=a.get(c.matchedUserId);return{...c,user:r?{id:r.id,fname:r.fname,lname:r.lname,fullName:r.fullName||"".concat(r.fname," ").concat(r.lname),profilePicture:r.profilePicture}:null,matchedUser:l?{id:l.id,fname:l.fname,lname:l.lname,fullName:l.fullName||"".concat(l.fname," ").concat(l.lname),profilePicture:l.profilePicture}:null}});return console.log("[AdminService] âœ¨ Found ".concat(i.length," unique pairings for date ").concat(n," (deduplicated from ").concat(p.length," matches)")),i}catch(o){return console.error("[AdminService] Error fetching magic intro pairings:",o),[]}}async getChannelPairingsByDate(s,n,u){try{console.log("[AdminService] ðŸ”— Fetching channel pairings by date for community ".concat(s));const d=await this.getMatchesForCommunity(s,n,u,"channel_pairing");if(!d||d.length===0)return[];const o=n?new Date(n):null,p=u?new Date(u):null,f=new Map;let t=0,m=0;d.forEach(i=>{const c=i.createdAt||i.created_at;if(!c){t++;return}let r;if(typeof c=="string"?r=new Date(c):c.toDate?r=c.toDate():c.seconds?r=new Date(c.seconds*1e3):r=new Date(c),isNaN(r.getTime())){t++,console.warn("[AdminService] Invalid date for channel pairing match ".concat(i.id,":"),c);return}if(o&&r<o){m++;return}if(p&&r>p){m++;return}const l=r.toISOString().split("T")[0];if(!/^\d{4}-\d{2}-\d{2}$/.test(l)){t++,console.warn("[AdminService] Invalid date string format for channel pairing match ".concat(i.id,":"),l);return}f.has(l)||f.set(l,[]),f.get(l).push(i)}),(t>0||m>0)&&console.log("[AdminService] ðŸ”— Filtered ".concat(d.length," channel pairing matches: ").concat(t," invalid dates, ").concat(m," out of range"));const e=await this.getConversationPairs(s),h=[];for(const[i,c]of f.entries()){const l=new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),v=new Set;c.forEach(y=>{var b,w;const C=y.channelName||y.channel_name||y.slackChannelName||y.slack_channel_name||((b=y.channel)==null?void 0:b.name)||((w=y.slackChannel)==null?void 0:w.name)||null;C&&v.add(C)});const g=v.size===1?Array.from(v)[0]:null,S=new Set,A=new Map;let $=0;const U=c.filter(y=>{const C=y.communityId||y.community_id;return C&&C!==s?($++,!1):!0});$>0&&console.warn("[AdminService] âš ï¸ Filtered out ".concat($," channel pairing matches with wrong communityId (expected ").concat(s,") for date ").concat(i)),console.log("[AdminService] After community filter for ".concat(i,": ").concat(U.length," matches (from ").concat(c.length," total)"));for(const y of U){const C=y.userId||y.user_id,b=y.matchedUserId||y.matched_user_id;if(!C||!b)continue;const w=[C,b].sort((I,k)=>I-k).join("-");if(!S.has(w)){S.add(w);const I=e.has(w);A.set(w,I)}}const _=Array.from(A.values()).filter(y=>y).length,M=S.size>0?_/S.size*100:0;h.push({date:i,dateDisplay:l,channelName:g,totalPairings:S.size,engagedPairings:_,engagementRate:Math.round(M*10)/10})}h.sort((i,c)=>c.date.localeCompare(i.date));const a=h.filter(i=>i.totalPairings>1e3);return a.length>0&&console.warn("[AdminService] âš ï¸ Found ".concat(a.length," channel pairing dates with >1000 pairings (possible data issue):"),a.map(i=>"".concat(i.date,": ").concat(i.totalPairings))),console.log("[AdminService] ðŸ”— Found ".concat(h.length," channel pairing dates, total pairings: ").concat(h.reduce((i,c)=>i+c.totalPairings,0))),h}catch(d){return console.error("[AdminService] Error fetching channel pairings by date:",d),[]}}async getChannelPairingPairings(s,n,u,d){var o,p;try{console.log("[AdminService] ðŸ”— Fetching pairings for channel pairing date ".concat(n));const f=await this.getMatchesForCommunity(s,u,d,"channel_pairing");if(!f||f.length===0)return[];const t=f.filter(g=>{const S=g.createdAt||g.created_at;if(!S)return!1;let A;typeof S=="string"?A=new Date(S):S.toDate?A=S.toDate():S.seconds?A=new Date(S.seconds*1e3):A=new Date(S);const $=A.toISOString().split("T")[0],U=n.includes("T")?n.split("T")[0]:n;return $===U}),m=await this.getConversationPairs(s),e=new Map;console.log("[AdminService] Processing ".concat(t.length," channel pairing matches for date ").concat(n)),t.length>0&&console.log("[AdminService] Sample channel pairing match:",{id:t[0].id,userId:t[0].userId,user_id:t[0].user_id,matchedUserId:t[0].matchedUserId,matched_user_id:t[0].matched_user_id,communityId:t[0].communityId,community_id:t[0].community_id,type:t[0].type,matchType:t[0].matchType,fullMatch:t[0]});let h=0;const a=t.filter(g=>{const S=g.communityId||g.community_id;return S&&S!==s?(h++,!1):!0});h>0&&console.warn("[AdminService] âš ï¸ Filtered out ".concat(h," channel pairing matches with wrong communityId (expected ").concat(s,")")),console.log("[AdminService] After community filter: ".concat(a.length," matches (from ").concat(t.length," total)")),t.length>0&&console.log("[AdminService] ðŸ” Sample channel pairing match structure:",{keys:Object.keys(t[0]),sampleMatch:t[0],hasChannelName:!!t[0].channelName,hasChannel_name:!!t[0].channel_name,hasSlackChannelName:!!t[0].slackChannelName,hasSlack_channel_name:!!t[0].slack_channel_name,hasChannel:!!t[0].channel,hasSlackChannel:!!t[0].slackChannel,hasSlack_channel_id:!!t[0].slack_channel_id,hasSlackChannelId:!!t[0].slackChannelId,groupId:t[0].groupId||t[0].group_id});for(const g of a){const S=g.userId||g.user_id,A=g.matchedUserId||g.matched_user_id;if(!S||!A){console.log("[AdminService] Skipping channel pairing match ".concat(g.id," - missing userId or matchedUserId"));continue}const $=[S,A].sort((U,_)=>U-_).join("-");if(e.has($))console.log("[AdminService] Skipping duplicate channel pairing pair ".concat($," (users ").concat(S," and ").concat(A,")"));else{const U=g.groupId||g.group_id||(g.matchIndicesId&&g.matchIndicesId!==0?g.matchIndicesId:null),_=g.channelName||g.channel_name||g.slackChannelName||g.slack_channel_name||((o=g.channel)==null?void 0:o.name)||((p=g.slackChannel)==null?void 0:p.name)||null,M=m.has($);e.set($,{...g,id:"pair-".concat($),groupId:U,userId:S,matchedUserId:A,isEngaged:M,channelName:_})}}const i=Array.from(e.values());console.log("[AdminService] Deduplicated to ".concat(i.length," unique channel pairing pairings from ").concat(t.length," matches")),i.length>0&&console.log("[AdminService] ðŸ” Sample pairing structure for channel name extraction:",{keys:Object.keys(i[0]),samplePairing:i[0],hasChannelName:!!i[0].channelName,hasChannel_name:!!i[0].channel_name,hasSlackChannelName:!!i[0].slackChannelName,hasSlack_channel_name:!!i[0].slack_channel_name,hasChannel:!!i[0].channel,hasSlackChannel:!!i[0].slackChannel,hasSlack_channel_id:!!i[0].slack_channel_id,hasSlackChannelId:!!i[0].slackChannelId,groupId:i[0].groupId||i[0].group_id});const c=new Set;i.forEach(g=>{g.userId&&c.add(g.userId),g.matchedUserId&&c.add(g.matchedUserId)});const{userService:r}=await L(()=>import("./index-CkJ7yJ3n.js").then(g=>g.bZ),__vite__mapDeps([1,2])),l=await r.getUsersByIds(Array.from(c)),v=i.map(g=>{var U,_;const S=l.get(g.userId),A=l.get(g.matchedUserId),$=g.channelName||g.channel_name||g.slackChannelName||g.slack_channel_name||((U=g.channel)==null?void 0:U.name)||((_=g.slackChannel)==null?void 0:_.name)||null;return{...g,channelName:$,user:S?{id:S.id,fname:S.fname,lname:S.lname,fullName:S.fullName||"".concat(S.fname," ").concat(S.lname),profilePicture:S.profilePicture}:null,matchedUser:A?{id:A.id,fname:A.fname,lname:A.lname,fullName:A.fullName||"".concat(A.fname," ").concat(A.lname),profilePicture:A.profilePicture}:null}});return console.log("[AdminService] ðŸ”— Found ".concat(v.length," unique channel pairing pairings for date ").concat(n," (deduplicated from ").concat(t.length," matches)")),v}catch(f){return console.error("[AdminService] Error fetching channel pairing pairings:",f),[]}}async getMentorMenteeMatchesByDate(s,n,u){try{console.log("[AdminService] ðŸŽ“ Fetching mentor/mentee matches by date for community ".concat(s),{startDate:n,endDate:u});const d=["mentor-mentee","mentor_mentee","mentor-match","mentor_mentee_match"];let o=[],p=!1,f=new Set;for(const r of d){console.log("[AdminService] ðŸŽ“ Trying type: ".concat(r));const l=await this.getMatchesForCommunity(s,n,u,r);if(l&&l.length>0){console.log("[AdminService] âœ… Found ".concat(l.length," matches with type: ").concat(r)),o=l;break}else console.log("[AdminService] âš ï¸ No matches found with type: ".concat(r))}if(!o||o.length===0){console.log("[AdminService] ðŸŽ“ No matches found with type filter, trying fallback: fetch all matches and filter client-side");let r=await this.getMatchesForCommunity(s,n,u);console.log("[AdminService] ðŸŽ“ Also fetching all-time matches (no date restrictions) to check for mentor/mentee matches outside date range");const l=await this.getMatchesForCommunity(s),v=new Map;if(r&&r.forEach(g=>v.set(g.id,g)),l&&l.forEach(g=>v.set(g.id,g)),r=Array.from(v.values()),console.log("[AdminService] ðŸŽ“ Combined ".concat(r.length," total matches (").concat(r.length-((l==null?void 0:l.length)||0)," from date range, ").concat((l==null?void 0:l.length)||0," from all-time)")),r&&r.length>0){console.log("[AdminService] ðŸŽ“ Fetched ".concat(r.length," total matches, filtering for mentor/mentee types..."));const g=new Set,S=new Set;r.forEach($=>{$.type&&f.add($.type),$.matchType&&g.add($.matchType),($.sub_type||$.subType)&&S.add($.sub_type||$.subType)}),console.log("[AdminService] ðŸŽ“ DEBUG: Found unique type values:",Array.from(f)),console.log("[AdminService] ðŸŽ“ DEBUG: Found unique matchType values:",Array.from(g)),console.log("[AdminService] ðŸŽ“ DEBUG: Found unique sub_type values:",Array.from(S));const A=Array.from(f).some($=>{const U=$.toLowerCase();return U.includes("mentor")||U.includes("mentee")});Array.from(f).length>0&&!A&&(p=!0,console.warn("[AdminService] âš ï¸ No mentor/mentee types found in response. Found types: ".concat(Array.from(f).join(", "))),console.warn("[AdminService] âš ï¸ This might indicate: (1) No mentor/mentee matches in date range, (2) Backend filtering issue, or (3) Type mismatch")),o=r.filter($=>{const U=$.type||$.matchType,_=$.sub_type||$.subType;if(U){const M=U.toLowerCase();if(M.includes("mentor")||M.includes("mentee"))return!0}if(_){const M=_.toLowerCase();if(M.includes("mentor")||M.includes("mentee"))return!0}return!1}),console.log("[AdminService] ðŸŽ“ Filtered to ".concat(o.length," mentor/mentee matches from ").concat(r.length," total matches")),o.length>0?console.log("[AdminService] ðŸŽ“ DEBUG: Sample mentor/mentee match:",o[0]):console.log("[AdminService] ðŸŽ“ DEBUG: No mentor/mentee matches found. Sample matches:",r.slice(0,3).map($=>({id:$.id,type:$.type,matchType:$.matchType,sub_type:$.sub_type||$.subType,userId:$.userId,matchedUserId:$.matchedUserId})))}}if(!o||o.length===0)return console.warn("[AdminService] âš ï¸ No mentor/mentee matches found. Tried type variations: ".concat(d.join(", ")," and client-side filtering")),!p&&f.size>0&&(p=!Array.from(f).some(r=>r.toLowerCase().includes("mentor")||r.toLowerCase().includes("mentee"))),{matches:[],hasBackendIssue:p};console.log("[AdminService] ðŸŽ“ Processing ".concat(o.length," mentor/mentee matches"));const t=n?new Date(n):null,m=u?new Date(u):null,e=new Map;let h=0,a=0;o.forEach(r=>{const l=r.createdAt||r.created_at;if(!l){h++;return}let v;if(typeof l=="string"?v=new Date(l):l.toDate?v=l.toDate():l.seconds?v=new Date(l.seconds*1e3):v=new Date(l),isNaN(v.getTime())){h++,console.warn("[AdminService] Invalid date for mentor/mentee match ".concat(r.id,":"),l);return}if(t&&v<t){a++;return}if(m&&v>m){a++;return}const g=v.toISOString().split("T")[0];if(!/^\d{4}-\d{2}-\d{2}$/.test(g)){h++,console.warn("[AdminService] Invalid date string format for mentor/mentee match ".concat(r.id,":"),g);return}e.has(g)||e.set(g,[]),e.get(g).push(r)}),(h>0||a>0)&&console.log("[AdminService] ðŸŽ“ Filtered ".concat(o.length," mentor/mentee matches: ").concat(h," invalid dates, ").concat(a," out of range"));const i=await this.getConversationPairs(s),c=[];for(const[r,l]of e.entries()){const g=new Date(r).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),S=new Set,A=new Map;let $=0;const U=l.filter(y=>{const C=y.communityId||y.community_id;return C&&C!==s?($++,!1):!0});$>0&&console.warn("[AdminService] âš ï¸ Filtered out ".concat($," mentor/mentee matches with wrong communityId (expected ").concat(s,") for date ").concat(r)),console.log("[AdminService] After community filter for ".concat(r,": ").concat(U.length," matches (from ").concat(l.length," total)"));for(const y of U){const C=y.userId||y.user_id,b=y.matchedUserId||y.matched_user_id;if(!C||!b)continue;const w=[C,b].sort((I,k)=>I-k).join("-");if(!S.has(w)){S.add(w);const I=i.has(w);A.set(w,I)}}const _=Array.from(A.values()).filter(y=>y).length,M=S.size>0?_/S.size*100:0;console.log("[AdminService] Mentor/Mentee Date ".concat(r,": ").concat(S.size," unique pairs, ").concat(_," engaged (from ").concat(l.length," matches)")),c.push({date:r,dateDisplay:g,totalPairings:S.size,engagedPairings:_,engagementRate:Math.round(M*10)/10})}return c.sort((r,l)=>l.date.localeCompare(r.date)),console.log("[AdminService] ðŸŽ“ Found ".concat(c.length," mentor/mentee match dates, total pairings: ").concat(c.reduce((r,l)=>r+l.totalPairings,0))),{matches:c,hasBackendIssue:p}}catch(d){return console.error("[AdminService] Error fetching mentor/mentee matches by date:",d),{matches:[],hasBackendIssue:!1}}}async getMentorMenteeUsersWithMatches(s,n,u){try{console.log("[AdminService] ðŸŽ“ Fetching users with mentor/mentee matches for community ".concat(s));const d=["mentor-mentee","mentor_mentee","mentor-match","mentor_mentee_match"];let o=[];for(const a of d){const i=await this.getMatchesForCommunity(s,n,u,a);if(i&&i.length>0){console.log("[AdminService] âœ… Found ".concat(i.length," matches with type: ").concat(a)),o=i;break}}if(!o||o.length===0){const a=await this.getMatchesForCommunity(s,n,u);a&&a.length>0&&(o=a.filter(i=>{const c=i.type||i.matchType,r=i.sub_type||i.subType;if(c){const l=c.toLowerCase();if(l.includes("mentor")||l.includes("mentee"))return!0}if(r){const l=r.toLowerCase();if(l.includes("mentor")||l.includes("mentee"))return!0}return!1}))}if(!o||o.length===0)return console.warn("[AdminService] âš ï¸ No mentor/mentee matches found"),[];const p=o.filter(a=>a.communityId===s),f=new Map;p.forEach(a=>{const i=a.userId||a.user_id;i&&f.set(i,(f.get(i)||0)+1)});const t=Array.from(f.keys()),{userService:m}=await L(()=>import("./index-CkJ7yJ3n.js").then(a=>a.bZ),__vite__mapDeps([1,2])),e=await m.getUsersByIds(t),h=Array.from(f.entries()).map(([a,i])=>{const c=e.get(a),r=c&&(c.fullName||"".concat(c.fname||""," ").concat(c.lname||"").trim())||"User ".concat(a);return{userId:a,userName:r,matchCount:i}}).sort((a,i)=>i.matchCount-a.matchCount);return console.log("[AdminService] ðŸŽ“ Found ".concat(h.length," users with mentor/mentee matches")),h}catch(d){return console.error("[AdminService] Error fetching users with mentor/mentee matches:",d),[]}}async getMentorMenteeMatchesForUser(s,n,u,d){try{console.log("[AdminService] ðŸŽ“ Fetching mentor/mentee matches for user ".concat(n));const o=["mentor-mentee","mentor_mentee","mentor-match","mentor_mentee_match"];let p=[];for(const a of o){const i=await this.getMatchesForCommunity(s,u,d,a);if(i&&i.length>0){p=i;break}}if(!p||p.length===0){const a=await this.getMatchesForCommunity(s,u,d);a&&a.length>0&&(p=a.filter(i=>{const c=i.type||i.matchType,r=i.sub_type||i.subType;if(c){const l=c.toLowerCase();if(l.includes("mentor")||l.includes("mentee"))return!0}if(r){const l=r.toLowerCase();if(l.includes("mentor")||l.includes("mentee"))return!0}return!1}))}if(!p||p.length===0)return[];const f=p.filter(a=>{const i=a.userId||a.user_id,c=a.matchedUserId||a.matched_user_id||a.otherUserId||a.other_user_id;return i===n&&c&&a.communityId===s}),t=[...new Set(f.map(a=>a.matchedUserId||a.matched_user_id||a.otherUserId||a.other_user_id).filter(Boolean))],{userService:m}=await L(()=>import("./index-CkJ7yJ3n.js").then(a=>a.bZ),__vite__mapDeps([1,2])),e=await m.getUsersByIds(t),h=f.map(a=>{const i=a.matchedUserId||a.matched_user_id||a.otherUserId||a.other_user_id,c=e.get(i),r=c&&(c.fullName||"".concat(c.fname||""," ").concat(c.lname||"").trim())||"User ".concat(i),l=a.sub_type||a.subType||"",v=l.toLowerCase(),g=v.includes("mentor-did-not-request")||v.includes("mentor-that-requested"),S=!g;return{id:a.id,matchedUserId:i,matchedUserName:r,createdAt:a.createdAt||a.created_at,subType:l,userWasMentor:g,userWasMentee:S}}).sort((a,i)=>new Date(i.createdAt).getTime()-new Date(a.createdAt).getTime());return console.log("[AdminService] ðŸŽ“ Found ".concat(h.length," mentor/mentee matches for user ").concat(n)),h}catch(o){return console.error("[AdminService] Error fetching mentor/mentee matches for user:",o),[]}}async getUsersWithConnections(s,n,u){try{console.log("[AdminService] ðŸ”— Fetching users with connections for community ".concat(s));const d=await this.getMatchesForCommunity(s,n,u);if(!d||d.length===0)return console.warn("[AdminService] âš ï¸ No matches found"),[];const o=d.filter(c=>{const r=c.userId||c.user_id,l=c.matchedUserId||c.matched_user_id||c.otherUserId||c.other_user_id,v=(c.type||c.matchType||"").toLowerCase();return v.includes("mentor")||v.includes("mentee")?!1:r&&l&&c.communityId===s}),p=new Map,f=new Map,t=[];o.forEach(c=>{const r=c.groupId||c.group_id||(c.matchIndicesId&&c.matchIndicesId!==0?c.matchIndicesId:null);if(r!=null){const l=String(r);f.has(l)||f.set(l,[]),f.get(l).push(c)}else t.push(c)}),f.forEach(c=>{const r=new Set;c.forEach(v=>{const g=v.userId||v.user_id,S=v.matchedUserId||v.matched_user_id||v.otherUserId||v.other_user_id;g&&r.add(g),S&&r.add(S)});const l=Array.from(r);l.forEach(v=>{p.has(v)||p.set(v,new Set),l.forEach(g=>{v!==g&&p.get(v).add(g)})})}),t.forEach(c=>{const r=c.userId||c.user_id,l=c.matchedUserId||c.matched_user_id||c.otherUserId||c.other_user_id;r&&l&&(p.has(r)||p.set(r,new Set),p.get(r).add(l),p.has(l)||p.set(l,new Set),p.get(l).add(r))});const m=Array.from(p.keys()),{userService:e}=await L(()=>import("./index-CkJ7yJ3n.js").then(c=>c.bZ),__vite__mapDeps([1,2])),h=50,a=new Map;for(let c=0;c<m.length;c+=h){const r=m.slice(c,c+h);(await e.getUsersByIds(r)).forEach((v,g)=>{a.set(g,v)})}const i=Array.from(p.entries()).map(([c,r])=>{const l=a.get(c),v=l&&(l.fullName||"".concat(l.fname||""," ").concat(l.lname||"").trim())||"User ".concat(c);return{userId:c,userName:v,connectionCount:r.size}}).filter(c=>c.connectionCount>0).sort((c,r)=>r.connectionCount-c.connectionCount);return console.log("[AdminService] ðŸ”— Found ".concat(i.length," users with connections")),i}catch(d){return console.error("[AdminService] Error fetching users with connections:",d),[]}}async getConnectionsForUser(s,n,u,d){try{console.log("[AdminService] ðŸ”— Fetching connections for user ".concat(n));const o=await this.getMatchesForCommunity(s,u,d);if(!o||o.length===0)return[];const p=o.filter(i=>{const c=i.userId||i.user_id,r=i.matchedUserId||i.matched_user_id||i.otherUserId||i.other_user_id,l=(i.type||i.matchType||"").toLowerCase();return l.includes("mentor")||l.includes("mentee")?!1:(c===n||r===n)&&c&&r&&i.communityId===s}),f=new Map;p.forEach(i=>{const c=i.userId||i.user_id,r=i.matchedUserId||i.matched_user_id||i.otherUserId||i.other_user_id,l=c===n?r:c;if(l&&l!==n)if(!f.has(l))f.set(l,i);else{const v=f.get(l),g=new Date(v.createdAt||v.created_at||0);new Date(i.createdAt||i.created_at||0)<g&&f.set(l,i)}});const t=Array.from(f.keys()),{userService:m}=await L(()=>import("./index-CkJ7yJ3n.js").then(i=>i.bZ),__vite__mapDeps([1,2])),e=50,h=new Map;for(let i=0;i<t.length;i+=e){const c=t.slice(i,i+e);(await m.getUsersByIds(c)).forEach((l,v)=>{h.set(v,l)})}const a=Array.from(f.entries()).map(([i,c])=>{const r=h.get(i),l=r&&(r.fullName||"".concat(r.fname||""," ").concat(r.lname||"").trim())||"User ".concat(i);return{id:c.id||"connection-".concat(n,"-").concat(i),connectedUserId:i,connectedUserName:l,createdAt:c.createdAt||c.created_at||"",matchType:c.type||c.matchType}}).sort((i,c)=>{const r=new Date(i.createdAt).getTime();return new Date(c.createdAt).getTime()-r});return console.log("[AdminService] ðŸ”— Found ".concat(a.length," connections for user ").concat(n)),a}catch(o){return console.error("[AdminService] Error fetching connections for user:",o),[]}}async getMentorMenteeMatchPairings(s,n,u,d){try{console.log("[AdminService] ðŸŽ“ Fetching pairings for mentor/mentee match date ".concat(n));const o=["mentor-mentee","mentor_mentee","mentor-match","mentor_mentee_match"];let p=[];for(const v of o){const g=await this.getMatchesForCommunity(s,u,d,v);if(g&&g.length>0){console.log("[AdminService] âœ… Found ".concat(g.length," matches with type: ").concat(v)),p=g;break}}if(!p||p.length===0){console.log("[AdminService] ðŸŽ“ No matches found with type filter, trying fallback: fetch all matches and filter client-side");const v=await this.getMatchesForCommunity(s,u,d);v&&v.length>0&&(p=v.filter(g=>{const S=g.type||g.matchType,A=g.sub_type||g.subType;if(S){const $=S.toLowerCase();if($.includes("mentor")||$.includes("mentee"))return!0}if(A){const $=A.toLowerCase();if($.includes("mentor")||$.includes("mentee"))return!0}return!1}),console.log("[AdminService] ðŸŽ“ Filtered to ".concat(p.length," mentor/mentee matches from ").concat(v.length," total matches")))}if(!p||p.length===0)return console.warn("[AdminService] âš ï¸ No mentor/mentee matches found with any type variation or client-side filtering"),[];const f=p.filter(v=>{const g=v.createdAt||v.created_at;if(!g)return!1;let S;typeof g=="string"?S=new Date(g):g.toDate?S=g.toDate():g.seconds?S=new Date(g.seconds*1e3):S=new Date(g);const A=S.toISOString().split("T")[0],$=n.includes("T")?n.split("T")[0]:n;return A===$}),t=await this.getConversationPairs(s),m=new Map;console.log("[AdminService] Processing ".concat(f.length," mentor/mentee matches for date ").concat(n));let e=0;const h=f.filter(v=>{const g=v.communityId||v.community_id;return g&&g!==s?(e++,!1):!0});e>0&&console.warn("[AdminService] âš ï¸ Filtered out ".concat(e," mentor/mentee matches with wrong communityId (expected ").concat(s,")")),console.log("[AdminService] After community filter: ".concat(h.length," matches (from ").concat(f.length," total)"));for(const v of h){const g=v.userId||v.user_id,S=v.matchedUserId||v.matched_user_id;if(!g||!S)continue;const A=[g,S].sort(($,U)=>$-U).join("-");if(!m.has(A)){const $=t.has(A);m.set(A,{...v,id:"pair-".concat(A),userId:g,matchedUserId:S,isEngaged:$})}}const a=Array.from(m.values());console.log("[AdminService] Deduplicated to ".concat(a.length," unique mentor/mentee pairings from ").concat(f.length," matches"));const i=new Set;a.forEach(v=>{v.userId&&i.add(v.userId),v.matchedUserId&&i.add(v.matchedUserId)});const{userService:c}=await L(()=>import("./index-CkJ7yJ3n.js").then(v=>v.bZ),__vite__mapDeps([1,2])),r=await c.getUsersByIds(Array.from(i)),l=a.map(v=>{const g=r.get(v.userId),S=r.get(v.matchedUserId);return{...v,user:g?{id:g.id,fname:g.fname,lname:g.lname,fullName:g.fullName||"".concat(g.fname," ").concat(g.lname),profilePicture:g.profilePicture}:null,matchedUser:S?{id:S.id,fname:S.fname,lname:S.lname,fullName:S.fullName||"".concat(S.fname," ").concat(S.lname),profilePicture:S.profilePicture}:null}});return console.log("[AdminService] ðŸŽ“ Found ".concat(l.length," unique mentor/mentee pairings for date ").concat(n," (deduplicated from ").concat(f.length," matches)")),l}catch(o){return console.error("[AdminService] Error fetching mentor/mentee match pairings:",o),[]}}}const oe=new ne;export{ne as AdminService,oe as adminService};
